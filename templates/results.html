{% extends "base.html" %}

{% block title %}Results - Trading Performance Analyzer{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-primary">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Trading Performance Analysis
                </h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-file-earmark me-1"></i>
                    {% if data.files_count and data.files_count > 1 %}
                        Files ({{ data.files_count }}): {{ data.filename[:100] }}{% if data.filename|length > 100 %}...{% endif %}
                    {% else %}
                        File: {{ data.filename }}
                    {% endif %} |
                    <i class="bi bi-clock me-1"></i>
                    Processed: {{ data.upload_time[:19] | replace('T', ' ') }}
                </p>
            </div>
            <div>
                <a href="/" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i>
                    New Analysis
                </a>
            </div>
        </div>
    </div>

    <!-- Main Navigation Tabs -->
    <div class="col-12">
        <ul class="nav nav-tabs nav-tabs-lg" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="trades-performance-tab" data-bs-toggle="tab" data-bs-target="#trades-performance" type="button" role="tab">
                    <i class="bi bi-graph-up me-2"></i>Trades Performance
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="open-positions-tab" data-bs-toggle="tab" data-bs-target="#open-positions" type="button" role="tab">
                    <i class="bi bi-briefcase me-2"></i>Open Positions
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="calculator-tab" data-bs-toggle="tab" data-bs-target="#calculator" type="button" role="tab">
                    <i class="bi bi-calculator me-2"></i>Calculator
                </button>
            </li>
        </ul>

        <!-- Main Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Trades Performance Tab -->
            <div class="tab-pane fade show active" id="trades-performance" role="tabpanel">
                {% if data.performance.summary.total_trades > 0 %}
                <!-- Enhanced Summary Cards (5 Key Metrics) -->
                <div class="row mb-4 mt-4">
                    <!-- Top Row - 3 Cards -->
                    <div class="col-md-4">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-trophy text-primary display-4 mb-3"></i>
                                <h3 class="card-title text-primary">{{ "%.1f"|format(data.performance.summary.batting_average) }}%</h3>
                                <p class="card-text text-muted">Batting Average</p>
                                <small class="text-muted">Win Rate</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-graph-up-arrow text-success display-4 mb-3"></i>
                                <h3 class="card-title text-success">+{{ "%.2f"|format(data.performance.summary.average_gain) }}%</h3>
                                <p class="card-text text-muted">Average Gain</p>
                                <small class="text-muted">Winners Only</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-graph-down-arrow text-danger display-4 mb-3"></i>
                                <h3 class="card-title text-danger">-{{ "%.2f"|format(data.performance.summary.average_loss) }}%</h3>
                                <p class="card-text text-muted">Average Loss</p>
                                <small class="text-muted">Losers Only</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <!-- Bottom Row - 2 Cards -->
                    <div class="col-md-6">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-calculator text-info display-4 mb-3"></i>
                                <h3 class="card-title text-info">{{ "%.2f"|format(data.performance.summary.win_loss_ratio) }}</h3>
                                <p class="card-text text-muted">Win/Loss Ratio</p>
                                <small class="text-muted">Avg Gain รท Avg Loss</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-gear text-warning display-4 mb-3"></i>
                                <h3 class="card-title text-warning">{{ "%.2f"|format(data.performance.summary.adjusted_win_loss_ratio) }}</h3>
                                <p class="card-text text-muted">Adjusted W/L Ratio</p>
                                <small class="text-muted">Accounts for Batting Avg</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Info Card -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <h5 class="text-primary">{{ data.performance.summary.total_trades }}</h5>
                                        <small class="text-muted">Total Trades</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h5 class="{% if data.performance.summary.net_return >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(data.performance.summary.net_return) }}%
                                        </h5>
                                        <small class="text-muted">Net Return</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h5 class="text-success">{{ data.performance.since_inception.Wins }}</h5>
                                        <small class="text-muted">Winning Trades</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h5 class="text-danger">{{ data.performance.since_inception.Losses }}</h5>
                                        <small class="text-muted">Losing Trades</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-graph-up me-2"></i>
                                    Performance Over Time
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <canvas id="performanceChart" width="400" height="200"></canvas>
                                    </div>
                                    <div class="col-lg-6">
                                        <canvas id="winLossChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Sub-tabs -->
                <div class="row">
                    <div class="col-12">
                        <ul class="nav nav-pills nav-fill" id="performanceSubTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                    <i class="bi bi-house me-1"></i>Since Inception
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab">
                                    <i class="bi bi-calendar-year me-1"></i>Yearly
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="quarterly-tab" data-bs-toggle="tab" data-bs-target="#quarterly" type="button" role="tab">
                                    <i class="bi bi-calendar3 me-1"></i>Quarterly
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">
                                    <i class="bi bi-calendar-month me-1"></i>Monthly
                                </button>
                            </li>
                        </ul>

                        <!-- Performance Sub-tab Content -->
                        <div class="tab-content mt-3" id="performanceSubTabContent">
                {% else %}
                <!-- No Closed Positions Message -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-info text-center" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>No Completed Trades</strong><br>
                            Your data contains open positions only. Switch to the <strong>"Open Positions"</strong> tab to view your current holdings and unrealized P&L.
                        </div>
                    </div>
                </div>
                {% endif %}
                            <!-- Since Inception Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Since Inception Performance</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="exportData('csv', 'since_inception')">
                                <i class="bi bi-download me-1"></i>CSV
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportData('excel', 'all')">
                                <i class="bi bi-file-earmark-excel me-1"></i>Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if data.performance.since_inception %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <tbody>
                                    <tr>
                                        <td><strong>Average Gain</strong></td>
                                        <td class="text-success">{{ "%.2f"|format(data.performance.since_inception['Avg Gain']) }}%</td>
                                        <td><strong>Average Loss</strong></td>
                                        <td class="text-danger">{{ "%.2f"|format(data.performance.since_inception['Avg Loss']) }}%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Net Return</strong></td>
                                        <td class="{% if data.performance.since_inception.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(data.performance.since_inception.Net) }}%
                                        </td>
                                        <td><strong>Win/Loss Ratio</strong></td>
                                        <td>{{ "%.2f"|format(data.performance.since_inception.Ratio) }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Wins</strong></td>
                                        <td class="text-success">{{ data.performance.since_inception.Wins }}</td>
                                        <td><strong>Losses</strong></td>
                                        <td class="text-danger">{{ data.performance.since_inception.Losses }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Largest Gain</strong></td>
                                        <td class="text-success">{{ "%.2f"|format(data.performance.since_inception['LG Gain']) }}%</td>
                                        <td><strong>Largest Loss</strong></td>
                                        <td class="text-danger">{{ "%.2f"|format(data.performance.since_inception['LG Loss']) }}%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Avg Days (Winners)</strong></td>
                                        <td>{{ data.performance.since_inception['Avg Days Gain'] }}</td>
                                        <td><strong>Avg Days (Losers)</strong></td>
                                        <td>{{ data.performance.since_inception['Avg Days Losses'] }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Commissions</strong></td>
                                        <td class="text-warning" colspan="3">${{ "%.2f"|format(data.performance.since_inception.COMM|abs) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

                            <!-- Yearly Tab -->
                            <div class="tab-pane fade" id="yearly" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Yearly Performance</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv', 'yearly')">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        {% if data.performance.yearly %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Year</th>
                                        <th>Net</th>
                                        <th>Win %</th>
                                        <th>Trades</th>
                                        <th>Avg Gain</th>
                                        <th>Avg Loss</th>
                                        <th>Ratio</th>
                                        <th>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data.performance.yearly %}
                                    <tr>
                                        <td><strong>{{ row.Date }}</strong></td>
                                        <td class="{% if row.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(row.Net) }}%
                                        </td>
                                        <td>{{ "%.1f"|format(row['Win %']) }}%</td>
                                        <td>{{ row['Total Trades'] }}</td>
                                        <td class="text-success">{{ "%.2f"|format(row['Avg Gain']) }}%</td>
                                        <td class="text-danger">{{ "%.2f"|format(row['Avg Loss']) }}%</td>
                                        <td>{{ "%.2f"|format(row.Ratio) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(row.COMM|abs) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No yearly data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

                            <!-- Quarterly Tab -->
                            <div class="tab-pane fade" id="quarterly" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Quarterly Performance</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv', 'quarterly')">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        {% if data.performance.quarterly %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Quarter</th>
                                        <th>Net</th>
                                        <th>Win %</th>
                                        <th>Trades</th>
                                        <th>Avg Gain</th>
                                        <th>Avg Loss</th>
                                        <th>Ratio</th>
                                        <th>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data.performance.quarterly %}
                                    <tr>
                                        <td><strong>{{ row.Date }}</strong></td>
                                        <td class="{% if row.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(row.Net) }}%
                                        </td>
                                        <td>{{ "%.1f"|format(row['Win %']) }}%</td>
                                        <td>{{ row['Total Trades'] }}</td>
                                        <td class="text-success">{{ "%.2f"|format(row['Avg Gain']) }}%</td>
                                        <td class="text-danger">{{ "%.2f"|format(row['Avg Loss']) }}%</td>
                                        <td>{{ "%.2f"|format(row.Ratio) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(row.COMM|abs) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No quarterly data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

                            <!-- Monthly Tab -->
                            <div class="tab-pane fade" id="monthly" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Monthly Performance</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv', 'monthly')">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        {% if data.performance.monthly %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Month</th>
                                        <th>Net</th>
                                        <th>Win %</th>
                                        <th>Trades</th>
                                        <th>Avg Gain</th>
                                        <th>Avg Loss</th>
                                        <th>Ratio</th>
                                        <th>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data.performance.monthly %}
                                    <tr>
                                        <td><strong>{{ row.Date }}</strong></td>
                                        <td class="{% if row.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(row.Net) }}%
                                        </td>
                                        <td>{{ "%.1f"|format(row['Win %']) }}%</td>
                                        <td>{{ row['Total Trades'] }}</td>
                                        <td class="text-success">{{ "%.2f"|format(row['Avg Gain']) }}%</td>
                                        <td class="text-danger">{{ "%.2f"|format(row['Avg Loss']) }}%</td>
                                        <td>{{ "%.2f"|format(row.Ratio) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(row.COMM|abs) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No monthly data available</p>
                        {% endif %}
                    </div>
                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Open Positions Tab -->
            <div class="tab-pane fade" id="open-positions" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-briefcase me-2"></i>Open Positions
                        </h5>
                        <div>
                            <div class="d-flex align-items-center gap-3">
                                <div class="d-flex align-items-center">
                                    <label for="timePeriodSelect" class="form-label me-2 mb-0 fw-bold">
                                        <i class="bi bi-clock me-1 text-primary"></i>Time Period:
                                    </label>
                                    <select class="form-select form-select-sm custom-select" id="timePeriodSelect" style="min-width: 180px;">
                                        <option value="since_inception">Since Inception</option>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="d-flex align-items-center">
                                    <label for="riskRatioSelect" class="form-label me-2 mb-0 fw-bold">
                                        <i class="bi bi-calculator me-1 text-success"></i>Risk Ratio:
                                    </label>
                                    <select class="form-select form-select-sm custom-select" id="riskRatioSelect" style="min-width: 120px;">
                                        <option value="none">Individual</option>
                                        <option value="2:1">2:1 (50%)</option>
                                        <option value="3:1">3:1 (33%)</option>
                                        <option value="4:1">4:1 (25%)</option>
                                        <option value="5:1">5:1 (20%)</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" id="refreshPricesBtn">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Refresh Prices
                                </button>
                            </div>
                            <small class="text-muted" id="lastUpdated"></small>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Loading State -->
                        <div id="openPositionsLoading" class="text-center py-4">
                            <div class="spinner-border text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Loading open positions...</span>
                        </div>

                        <!-- Error State -->
                        <div id="openPositionsError" class="alert alert-danger d-none" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="errorMessage">Error loading open positions</span>
                        </div>

                        <!-- No Positions State -->
                        <div id="noOpenPositions" class="text-center py-4 d-none">
                            <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                            <h5 class="text-muted">No Open Positions</h5>
                            <p class="text-muted">All positions have been closed.</p>
                        </div>

                        <!-- Summary Cards -->
                        <div id="openPositionsSummary" class="d-none">
                            <!-- First Row - Portfolio Metrics -->
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-cash-stack text-primary display-6 mb-2"></i>
                                            <h6 class="card-title text-primary" id="totalMarketValue">$0.00</h6>
                                            <p class="card-text text-muted small">Market Value</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-piggy-bank text-secondary display-6 mb-2"></i>
                                            <h6 class="card-title text-secondary" id="totalCostBasis">$0.00</h6>
                                            <p class="card-text text-muted small">Cost Basis</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-graph-up-arrow display-6 mb-2" id="totalPnlIcon"></i>
                                            <h6 class="card-title" id="totalUnrealizedPnl">$0.00</h6>
                                            <p class="card-text text-muted small">Unrealized P&L</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-percent display-6 mb-2" id="overallPnlIcon"></i>
                                            <h6 class="card-title" id="overallPnlPct">0.00%</h6>
                                            <p class="card-text text-muted small">Overall %</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Second Row - Risk Management Metrics -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-shield-exclamation text-warning display-6 mb-2"></i>
                                            <h6 class="card-title text-warning" id="totalRiskExposure">$0.00</h6>
                                            <p class="card-text text-muted small">Total Risk</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-check-circle text-info display-6 mb-2"></i>
                                            <h6 class="card-title text-info" id="activeStopsCount">0</h6>
                                            <p class="card-text text-muted small">Active Stops</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-exclamation-triangle text-danger display-6 mb-2"></i>
                                            <h6 class="card-title text-danger" id="triggeredStopsCount">0</h6>
                                            <p class="card-text text-muted small">Triggered Stops</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-shield-check text-primary display-6 mb-2"></i>
                                            <h6 class="card-title text-primary" id="averageStopLossPercent">0.0%</h6>
                                            <p class="card-text text-muted small">Applied Stop Loss %</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Positions Table -->
                        <div id="openPositionsTable" class="d-none">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th width="30"></th>
                                            <th>Symbol</th>
                                            <th>Type</th>
                                            <th class="text-end">Peak/Current</th>
                                            <th class="text-end">Avg Price</th>
                                            <th class="text-end">Current Price</th>
                                            <th class="text-end">Stop Loss</th>
                                            <th class="text-end">Risk ($)</th>
                                            <th class="text-end">R-Multiple</th>
                                            <th class="text-end">SBE</th>
                                            <th class="text-end">Realized P&L</th>
                                            <th class="text-end">Unrealized P&L</th>
                                            <th class="text-end">Remaining P&L (%)</th>
                                            <th class="text-end">Overall P&L (%)</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="openPositionsTableBody">
                                        <!-- Positions will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Export Options -->
    <div class="col-12 mt-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-download me-2"></i>
                    Export Options
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Raw Data</h6>
                        <button class="btn btn-outline-secondary me-2 mb-2" onclick="exportData('roundtrips', 'all')">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>
                            Download Roundtrips CSV
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Performance Reports</h6>
                        <button class="btn btn-outline-success mb-2" onclick="exportData('excel', 'all')">
                            <i class="bi bi-file-earmark-excel me-1"></i>
                            Complete Excel Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stop Loss Modal -->
<div class="modal fade" id="stopLossModal" tabindex="-1" aria-labelledby="stopLossModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="stopLossModalLabel">
                    <i class="bi bi-shield-exclamation me-2"></i>Set Stop Loss
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="stopLossForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Position Details</label>
                        <div class="card bg-light">
                            <div class="card-body py-2">
                                <div class="row">
                                    <div class="col-md-4">
                                        <small class="text-muted">Symbol:</small>
                                        <div id="modalSymbol" class="fw-bold">-</div>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Type:</small>
                                        <div id="modalPositionType" class="fw-bold">-</div>
                                    </div>
                                    <div class="col-md-4">
                                        <small class="text-muted">Entry Price:</small>
                                        <div id="modalEntryPrice" class="fw-bold">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Stop Loss Type</label>
                        <div class="btn-group w-100" role="group" aria-label="Stop loss type">
                            <input type="radio" class="btn-check" name="stopType" id="stopTypeAmount" value="amount" checked>
                            <label class="btn btn-outline-primary" for="stopTypeAmount">
                                <i class="bi bi-currency-dollar me-1"></i>Dollar Amount
                            </label>
                            
                            <input type="radio" class="btn-check" name="stopType" id="stopTypePercentage" value="percentage">
                            <label class="btn btn-outline-primary" for="stopTypePercentage">
                                <i class="bi bi-percent me-1"></i>Percentage
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="stopValue" class="form-label fw-bold">Stop Loss Value</label>
                        <div class="input-group">
                            <span class="input-group-text" id="stopValuePrefix">$</span>
                            <input type="number" class="form-control" id="stopValue" step="0.01" min="0" required>
                            <span class="input-group-text" id="stopValueSuffix"></span>
                        </div>
                        <div class="form-text" id="stopValueHelp">Enter the dollar amount to risk per share</div>
                    </div>
                    
                    <div class="alert alert-info" role="alert">
                        <h6 class="alert-heading">
                            <i class="bi bi-calculator me-1"></i>Risk Calculation Preview
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Stop Loss Price:</small>
                                <div id="previewStopPrice" class="fw-bold">-</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Total Risk:</small>
                                <div id="previewTotalRisk" class="fw-bold">-</div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Risk per Share:</small>
                                <div id="previewRiskPerShare" class="fw-bold">-</div>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Risk %:</small>
                                <div id="previewRiskPercentage" class="fw-bold">-</div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveStopLossBtn">
                    <i class="bi bi-shield-check me-1"></i>Set Stop Loss
                </button>
            </div>
        </div>
    </div>
</div>

            <!-- Calculator Tab -->
            <div class="tab-pane fade" id="calculator" role="tabpanel">
                <div class="container-fluid mt-4">
                    <h4 class="mb-4"><i class="bi bi-calculator"></i> Trading Calculators</h4>

                    <div class="row">
                        <!-- Risk Calculator Card -->
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="bi bi-shield-check"></i> Risk Calculator</h5>
                                </div>
                                <div class="card-body">
                                    <!-- Mode Selector -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">Calculation Mode:</label>
                                        <div class="btn-group w-100" role="group">
                                            <input type="radio" class="btn-check" name="calcMode" id="mode1" value="shares" checked>
                                            <label class="btn btn-outline-primary" for="mode1">
                                                <i class="bi bi-123"></i> Calculate Shares & Risk
                                            </label>
                                            <input type="radio" class="btn-check" name="calcMode" id="mode2" value="risk">
                                            <label class="btn btn-outline-primary" for="mode2">
                                                <i class="bi bi-pie-chart"></i> Calculate Position Size
                                            </label>
                                        </div>
                                        <small class="text-muted d-block mt-2" id="modeDescription">
                                            Enter target position size % and stop loss % to calculate shares and risk amount
                                        </small>
                                    </div>

                                    <!-- Common Inputs -->
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Symbol</label>
                                            <input type="text" id="riskSymbol" class="form-control" placeholder="AAPL">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Entry Price ($)</label>
                                            <input type="number" id="riskPrice" class="form-control" step="0.01" min="0.01" placeholder="100.00">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Portfolio Size ($)</label>
                                            <input type="number" id="riskPortfolio" class="form-control" step="0.01" min="1" placeholder="100000">
                                        </div>
                                    </div>

                                    <!-- Mode 1 Inputs -->
                                    <div id="mode1Inputs" class="mode-inputs">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Target Position Size (%)</label>
                                                <input type="number" id="targetPositionPct" class="form-control" step="0.1" min="0.1" placeholder="5">
                                                <small class="text-muted">% of portfolio to allocate</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Stop Loss (%)</label>
                                                <input type="number" id="stopLossPct" class="form-control" step="0.1" min="0.1" placeholder="2">
                                                <small class="text-muted">% below entry price</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Mode 2 Inputs -->
                                    <div id="mode2Inputs" class="mode-inputs d-none">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Risk per Trade (%)</label>
                                                <input type="number" id="riskPerTradePct" class="form-control" step="0.1" min="0.1" placeholder="1">
                                                <small class="text-muted">% of portfolio you're willing to risk</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Stop Loss (%)</label>
                                                <input type="number" id="stopLossPctMode2" class="form-control" step="0.1" min="0.1" placeholder="2">
                                                <small class="text-muted">% below entry price</small>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Calculate Button -->
                                    <button id="calculateRiskBtn" class="btn btn-primary w-100 mb-3">
                                        <i class="bi bi-calculator"></i> Calculate
                                    </button>

                                    <!-- Results -->
                                    <div id="riskResults" class="d-none">
                                        <hr>
                                        <h6 class="text-primary mb-3"><i class="bi bi-check-circle"></i> Results:</h6>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="result-item">
                                                    <small class="text-muted">Number of Shares</small>
                                                    <div class="h5 text-primary" id="resultShares">-</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="result-item">
                                                    <small class="text-muted">Position Value</small>
                                                    <div class="h5 text-primary" id="resultPositionValue">-</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="result-item">
                                                    <small class="text-muted">Position Size (%)</small>
                                                    <div class="h5 text-info" id="resultPositionPct">-</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="result-item">
                                                    <small class="text-muted">Stop Loss Price</small>
                                                    <div class="h5 text-warning" id="resultStopPrice">-</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="result-item">
                                                    <small class="text-muted">Risk Amount ($)</small>
                                                    <div class="h5 text-danger" id="resultRiskAmount">-</div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="result-item">
                                                    <small class="text-muted">Risk as % of Equity</small>
                                                    <div class="h5 text-danger" id="resultRiskPct">-</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Placeholder for future calculators -->
                        <div class="col-lg-6 mb-4">
                            <div class="card shadow-sm bg-light">
                                <div class="card-body text-center py-5">
                                    <i class="bi bi-plus-circle display-1 text-muted mb-3"></i>
                                    <h5 class="text-muted">More Calculators Coming Soon</h5>
                                    <p class="text-muted mb-0">R-Multiple, Break-Even, Position Rebalancing, and more...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_styles %}
<style>
#calculator .result-item {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #0d6efd;
    transition: all 0.3s ease;
}

#calculator .result-item:hover {
    background: #e9ecef;
    transform: translateX(3px);
}

#calculator .result-item small {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

#calculator .btn-group label {
    white-space: nowrap;
    padding: 10px 20px;
}

.mode-inputs {
    transition: opacity 0.3s ease;
}

#calculator .card {
    transition: box-shadow 0.3s ease;
}

#calculator .card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

#riskResults {
    animation: slideIn 0.4s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Global session ID
const SESSION_ID = '{{ session_id }}';

// Open Positions functionality
let autoRefreshInterval = null;

// Initialize tabs and functionality
document.addEventListener('DOMContentLoaded', function() {
    const tradesPerformanceTab = document.getElementById('trades-performance-tab');
    const openPositionsTab = document.getElementById('open-positions-tab');
    const refreshBtn = document.getElementById('refreshPricesBtn');
    
    // Initialize charts when trades performance tab is shown
    if (tradesPerformanceTab) {
        tradesPerformanceTab.addEventListener('shown.bs.tab', function() {
            // Small delay to ensure tab content is visible before initializing charts
            setTimeout(() => {
                initializeCharts();
            }, 100);
        });
    }
    
    // Initialize open positions when tab is shown
    if (openPositionsTab) {
        openPositionsTab.addEventListener('shown.bs.tab', function() {
            loadTimePeriods(); // Load available time periods first
            loadOpenPositions();
            startAutoRefresh();
        });
        
        openPositionsTab.addEventListener('hidden.bs.tab', function() {
            stopAutoRefresh();
        });
    }
    
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            refreshPrices();
        });
    }
    
    // Initialize charts on page load (trades performance tab is active by default)
    setTimeout(() => {
        initializeCharts();
    }, 100);
    
    // Check if open positions tab is already active on page load
    if (openPositionsTab && openPositionsTab.classList.contains('active')) {
        loadTimePeriods();
        loadOpenPositions();
        startAutoRefresh();
    }
    
    // Stop Loss Modal Event Listeners
    const stopTypeRadios = document.querySelectorAll('input[name="stopType"]');
    stopTypeRadios.forEach(radio => {
        radio.addEventListener('change', updateStopTypeUI);
    });
    
    const stopValueInput = document.getElementById('stopValue');
    if (stopValueInput) {
        stopValueInput.addEventListener('input', calculateStopLossPreview);
    }
    
    const saveStopLossBtn = document.getElementById('saveStopLossBtn');
    if (saveStopLossBtn) {
        saveStopLossBtn.addEventListener('click', saveStopLoss);
    }
    
    // Auto-apply risk ratio on dropdown changes
    const timePeriodSelect = document.getElementById('timePeriodSelect');
    const riskRatioSelect = document.getElementById('riskRatioSelect');
    
    if (timePeriodSelect) {
        timePeriodSelect.addEventListener('change', autoApplyRiskRatio);
    }
    
    if (riskRatioSelect) {
        riskRatioSelect.addEventListener('change', autoApplyRiskRatio);
    }
});

async function loadTimePeriods() {
    try {
        const response = await fetch(`/api/time-periods/${SESSION_ID}`);
        const data = await response.json();
        
        if (response.ok && data.periods) {
            const timePeriodSelect = document.getElementById('timePeriodSelect');
            if (timePeriodSelect) {
                // Clear existing options except the first one
                timePeriodSelect.innerHTML = '';
                
                // Populate with available periods
                data.periods.forEach(period => {
                    const option = document.createElement('option');
                    option.value = period.value;
                    option.textContent = period.label;
                    timePeriodSelect.appendChild(option);
                });
                
                // Set default to since_inception if available
                if (data.periods.length > 0) {
                    const defaultPeriod = data.periods.find(p => p.value === 'since_inception');
                    if (defaultPeriod) {
                        timePeriodSelect.value = 'since_inception';
                    } else {
                        timePeriodSelect.value = data.periods[0].value;
                    }
                }
            }
        }
    } catch (error) {
        console.error('Error loading time periods:', error);
        // Keep default option if error occurs
    }
}

async function loadOpenPositions() {
    showLoadingState();
    
    try {
        const response = await fetch(`/api/open-positions/${SESSION_ID}`);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Error:', response.status, errorText);
            try {
                const errorData = JSON.parse(errorText);
                showError(errorData.detail || 'Failed to load open positions');
            } catch {
                showError(`Server error: ${response.status} - ${errorText}`);
            }
            return;
        }
        
        const data = await response.json();
        console.log('Open positions loaded:', data);
        displayOpenPositions(data);
        updateLastUpdated();
        
    } catch (error) {
        console.error('Error loading open positions:', error);
        showError('Network error loading open positions: ' + error.message);
    }
}

async function refreshPrices() {
    const refreshBtn = document.getElementById('refreshPricesBtn');
    const originalContent = refreshBtn.innerHTML;
    
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1 spinner-border spinner-border-sm"></i>Refreshing...';
    
    try {
        const response = await fetch(`/api/refresh-prices/${SESSION_ID}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (response.ok) {
            updatePositionsWithFreshData(data);
            updateLastUpdated();
        } else {
            showError(data.detail || 'Failed to refresh prices');
        }
    } catch (error) {
        console.error('Error refreshing prices:', error);
        showError('Network error refreshing prices');
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalContent;
    }
}

function displayOpenPositions(data) {
    hideAllStates();
    
    if (!data.positions || data.positions.length === 0) {
        document.getElementById('noOpenPositions').classList.remove('d-none');
        return;
    }
    
    // Store positions data for modal calculations
    window.lastPositionsData = data.positions;
    
    // Show summary and table
    document.getElementById('openPositionsSummary').classList.remove('d-none');
    document.getElementById('openPositionsTable').classList.remove('d-none');
    
    // Update summary cards
    updateSummaryCards(data.summary);
    
    // Update positions table
    updatePositionsTable(data.positions);
}

function updateSummaryCards(summary) {
    // Total Market Value
    document.getElementById('totalMarketValue').textContent = formatCurrency(summary.total_market_value);
    
    // Total Cost Basis
    document.getElementById('totalCostBasis').textContent = formatCurrency(summary.total_cost_basis);
    
    // Total Unrealized P&L
    const totalPnl = summary.total_unrealized_pnl;
    const totalPnlElement = document.getElementById('totalUnrealizedPnl');
    const totalPnlIcon = document.getElementById('totalPnlIcon');
    
    totalPnlElement.textContent = formatCurrency(totalPnl);
    totalPnlElement.className = `card-title ${totalPnl >= 0 ? 'text-success' : 'text-danger'}`;
    totalPnlIcon.className = `bi ${totalPnl >= 0 ? 'bi-graph-up-arrow text-success' : 'bi-graph-down-arrow text-danger'} display-6 mb-2`;
    
    // Overall P&L %
    const overallPct = summary.overall_pnl_pct;
    const overallPctElement = document.getElementById('overallPnlPct');
    const overallPnlIcon = document.getElementById('overallPnlIcon');
    
    overallPctElement.textContent = formatPercentage(overallPct);
    overallPctElement.className = `card-title ${overallPct >= 0 ? 'text-success' : 'text-danger'}`;
    overallPnlIcon.className = `bi bi-percent ${overallPct >= 0 ? 'text-success' : 'text-danger'} display-6 mb-2`;
    
    // Risk Management Metrics
    // Total Risk Exposure
    const totalRisk = summary.total_risk_exposure || 0;
    document.getElementById('totalRiskExposure').textContent = formatCurrency(totalRisk);
    
    // Active Stops Count
    const activeStops = summary.active_stops_count || 0;
    document.getElementById('activeStopsCount').textContent = activeStops;
    
    // Triggered Stops Count
    const triggeredStops = summary.triggered_stops_count || 0;
    document.getElementById('triggeredStopsCount').textContent = triggeredStops;
    
    // Average Stop Loss Percentage
    const avgStopLossPercent = summary.average_stop_loss_percentage || 0;
    const avgStopLossElement = document.getElementById('averageStopLossPercent');
    avgStopLossElement.textContent = `${avgStopLossPercent.toFixed(1)}%`;
    avgStopLossElement.className = 'card-title text-primary';
}

function updatePositionsTable(positions) {
    const tbody = document.getElementById('openPositionsTableBody');
    tbody.innerHTML = '';
    
    // Check if a risk ratio is currently applied (not individual)
    const riskRatioSelect = document.getElementById('riskRatioSelect');
    const isRiskRatioApplied = riskRatioSelect && riskRatioSelect.value !== 'none';
    
    positions.forEach(position => {
        const row = document.createElement('tr');
        
        const pnlDollar = position.unrealized_pnl;
        const pnlPercent = position.unrealized_pnl_pct;
        const pnlClass = (pnlDollar >= 0) ? 'text-success' : 'text-danger';
        const currentPriceDisplay = position.current_price !== null && position.current_price !== undefined ? `$${position.current_price.toFixed(4)}` : 'N/A';
        
        // Stop loss and risk information
        const stopLoss = position.stop_loss;
        const rMultiple = position.r_multiple;
        
        let stopLossDisplay = 'Not Set';
        let riskDisplay = '-';
        let rMultipleDisplay = '-';
        // Actions depend on whether risk ratio is applied automatically or individual management
        let actionsHtml = '';
        
        if (isRiskRatioApplied) {
            // When risk ratio is applied, don't show manual stop loss controls
            actionsHtml = '<span class="text-muted small">Auto-managed</span>';
        } else {
            // Individual management - show manual controls
            if (stopLoss) {
                actionsHtml = `
                    <button class="btn btn-sm btn-outline-danger" onclick="removeStopLoss('${position.symbol}')">Remove</button>
                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="showStopLossModal('${position.symbol}', ${position.avg_entry_price}, '${position.position_type}')">Edit</button>
                `;
            } else {
                actionsHtml = `<button class="btn btn-sm btn-outline-primary" onclick="showStopLossModal('${position.symbol}', ${position.avg_entry_price}, '${position.position_type}')">Set Stop</button>`;
            }
        }
        
        if (stopLoss && stopLoss.price !== null && stopLoss.price !== undefined) {
            stopLossDisplay = `$${stopLoss.price.toFixed(4)}`;
            riskDisplay = formatCurrency(stopLoss.risk_amount);
            
            if (stopLoss.is_triggered) {
                stopLossDisplay += ' <span class="badge bg-danger ms-1">TRIGGERED</span>';
                row.classList.add('table-danger'); // Red background for triggered stops
            }
        }
        
        if (rMultiple !== null && rMultiple !== undefined) {
            const rValue = Math.abs(rMultiple);
            let rClass = 'text-muted';
            let rText = `${rMultiple.toFixed(2)}R`;
            
            if (rMultiple >= 1) {
                rClass = 'text-success fw-bold';
                // Highlight R-Multiple milestones
                if (rMultiple >= 2 && rMultiple < 3) {
                    row.classList.add('table-success');
                } else if (rMultiple >= 3) {
                    row.classList.add('table-success');
                    rText += ' ๐ฏ';
                }
            } else if (rMultiple >= 0.5) {
                rClass = 'text-warning';
            } else if (rMultiple < 0) {
                rClass = 'text-danger';
            }
            
            rMultipleDisplay = `<span class="${rClass}">${rText}</span>`;
        }
        
        // SBE (Shares to Break Even) Information
        let sbeDisplay = '-';
        
        // Only calculate SBE if position is profitable
        if (position.unrealized_pnl !== null && position.unrealized_pnl <= 0) {
            // Position is at a loss or breakeven - no SBE calculation needed
            sbeDisplay = '<span class="text-muted">-</span>';
        } else if (position.current_price !== null && position.current_price !== undefined && position.current_price > 0 && position.cost_basis) {
            // Position is profitable - calculate SBE
            const sharesToSell = Math.round(position.cost_basis / position.current_price);
            const sbePercentage = (sharesToSell / position.quantity) * 100;
            
            if (sharesToSell > 0 && sharesToSell < position.quantity) {
                // Can freeroll - show shares to sell
                const sharesRemaining = position.quantity - sharesToSell;
                const recoveryAmount = sharesToSell * position.current_price;
                
                // Green bold for profitable positions
                sbeDisplay = `
                    <span class="text-success fw-bold" title="SBE: Sell ${sharesToSell} shares (${sbePercentage.toFixed(1)}%) at $${position.current_price.toFixed(4)} to recover $${recoveryAmount.toFixed(2)} and freeroll ${sharesRemaining} shares">
                        ${sharesToSell}
                        <small class="text-muted">(${sbePercentage.toFixed(0)}%)</small>
                    </span>
                `;
                
                // Add green highlighting for profitable positions
                if (!row.classList.contains('table-danger')) {
                    row.classList.add('table-success');
                }
            } else if (sharesToSell >= position.quantity) {
                // Need to sell all shares (position not profitable enough for freeroll)
                sbeDisplay = `<span class="text-warning" title="Current price $${position.current_price.toFixed(4)} requires selling all ${position.quantity} shares to break even.">All</span>`;
            } else {
                sbeDisplay = '<span class="text-success">0</span>';
            }
        } else {
            // No current price available
            sbeDisplay = '<span class="text-muted">-</span>';
        }
        
        // Peak/Current display
        const peakCurrentDisplay = position.high_water_mark ? `
            <span title="Peak position: ${position.high_water_mark} shares, Currently own: ${position.quantity} shares" 
                  class="${position.quantity === position.high_water_mark ? 'text-success fw-bold' : 'text-muted'}">
                ${position.high_water_mark}/${position.quantity}
            </span>
        ` : `${position.quantity}`;

        // Realized P&L display
        const realizedPnlDisplay = position.realized_pnl !== undefined ? 
            `<span class="${position.realized_pnl >= 0 ? 'text-success' : 'text-danger'}">
                ${formatCurrency(position.realized_pnl)}
            </span>` : '-';

        // Remaining P&L % display (percentage return on current position)
        const remainingPnlClass = position.unrealized_pnl_pct >= 0 ? 'text-success' : 'text-danger';
        const remainingPnlDisplay = position.unrealized_pnl_pct !== null ? `
            <span class="${remainingPnlClass}" 
                  title="Percentage return on current ${position.quantity} shares held">
                ${position.unrealized_pnl_pct.toFixed(2)}%
            </span>
        ` : 'N/A';

        // Overall P&L % display (total return including realized gains)
        const overallPnlClass = position.total_pnl_pct >= 0 ? 'text-success' : 'text-danger';
        const overallPnlDisplay = position.total_pnl_pct !== null ? `
            <span class="${overallPnlClass} fw-bold" 
                  title="Overall return including ${formatCurrency(position.realized_pnl || 0)} realized and ${formatCurrency(position.unrealized_pnl || 0)} unrealized">
                ${position.total_pnl_pct.toFixed(2)}%
            </span>
        ` : 'N/A';

        row.innerHTML = `
            <td class="text-center">
                <i class="bi bi-chevron-right expand-arrow" 
                   data-symbol="${position.symbol}" 
                   style="cursor: pointer;"
                   title="Click to view trade details"></i>
            </td>
            <td><strong>${position.symbol}</strong></td>
            <td>
                <span class="badge ${position.position_type === 'Long' ? 'bg-success' : 'bg-warning text-dark'}">
                    ${position.position_type}
                </span>
            </td>
            <td class="text-end">${peakCurrentDisplay}</td>
            <td class="text-end">${position.avg_entry_price !== null && position.avg_entry_price !== undefined ? `$${position.avg_entry_price.toFixed(4)}` : 'N/A'}</td>
            <td class="text-end">${currentPriceDisplay}</td>
            <td class="text-end">${stopLossDisplay}</td>
            <td class="text-end">${riskDisplay}</td>
            <td class="text-end">${rMultipleDisplay}</td>
            <td class="text-end">${sbeDisplay}</td>
            <td class="text-end">${realizedPnlDisplay}</td>
            <td class="text-end ${pnlClass}">
                ${pnlDollar !== null ? formatCurrency(pnlDollar) : 'N/A'}
            </td>
            <td class="text-end">${remainingPnlDisplay}</td>
            <td class="text-end">${overallPnlDisplay}</td>
            <td class="text-center">${actionsHtml}</td>
        `;
        
        tbody.appendChild(row);
        
        // Create and append detail row (initially hidden)
        const detailRow = createDetailRow(position);
        tbody.appendChild(detailRow);
    });
    
    // Add click event listeners for expand/collapse arrows
    addExpandCollapseListeners();
}

function createDetailRow(position) {
    const detailRow = document.createElement('tr');
    detailRow.className = 'trade-detail-row d-none';
    detailRow.id = `detail-${position.symbol}`;
    
    // Create detail cell that spans all columns
    const detailCell = document.createElement('td');
    detailCell.colSpan = 15; // Span all columns in the table (added one more column)
    detailCell.className = 'p-0';
    
    // Build detailed trade history content
    let detailHTML = `
        <div class="card border-0 m-2">
            <div class="card-header bg-light">
                <h6 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>
                    Trade History for ${position.symbol}
                </h6>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Position Summary:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><strong>Peak Position:</strong> ${position.high_water_mark !== null && position.high_water_mark !== undefined ? position.high_water_mark.toLocaleString() : 'N/A'} shares</li>
                            <li><strong>Current Position:</strong> ${position.quantity !== null && position.quantity !== undefined ? position.quantity.toLocaleString() : 'N/A'} shares</li>
                            <li><strong>Total Lots:</strong> ${position.lots ? position.lots.length : 0}</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <strong>P&L Breakdown:</strong>
                        <ul class="list-unstyled mt-2">
                            <li><strong>Realized P&L:</strong> ${formatCurrency(position.realized_pnl || 0)}</li>
                            <li><strong>Unrealized P&L:</strong> ${position.unrealized_pnl !== null ? formatCurrency(position.unrealized_pnl) : 'N/A'}</li>
                            <li><strong>Total P&L:</strong> ${position.total_pnl !== null ? formatCurrency(position.total_pnl) : 'N/A'}</li>
                        </ul>
                    </div>
                </div>`;
    
    // Add individual lots table if available
    if (position.lots && position.lots.length > 0) {
        detailHTML += `
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>Entry Date</th>
                                <th class="text-end">Original Qty</th>
                                <th class="text-end">Remaining Qty</th>
                                <th class="text-end">Entry Price</th>
                                <th class="text-end">Cost Basis</th>
                                <th class="text-end">Commission</th>
                                <th class="text-end">Market Value</th>
                                <th class="text-end">P&L ($)</th>
                                <th class="text-end">P&L (%)</th>
                            </tr>
                        </thead>
                        <tbody>`;
        
        position.lots.forEach(lot => {
            const currentValue = position.current_price ? (lot.quantity_remaining * position.current_price) : null;
            const lotPnl = currentValue ? (currentValue - lot.cost_basis) : null;
            const lotPnlPercent = (lotPnl !== null && lot.cost_basis > 0) ? ((lotPnl / lot.cost_basis) * 100) : null;
            const pnlClass = lotPnl !== null ? (lotPnl >= 0 ? 'text-success' : 'text-danger') : '';
            
            detailHTML += `
                            <tr>
                                <td>${lot.entry_date}</td>
                                <td class="text-end">${lot.original_quantity !== null && lot.original_quantity !== undefined ? lot.original_quantity.toLocaleString() : 'N/A'}</td>
                                <td class="text-end">${lot.quantity_remaining !== null && lot.quantity_remaining !== undefined ? lot.quantity_remaining.toLocaleString() : 'N/A'}</td>
                                <td class="text-end">${lot.entry_price !== null && lot.entry_price !== undefined ? `$${lot.entry_price.toFixed(4)}` : 'N/A'}</td>
                                <td class="text-end">${formatCurrency(lot.cost_basis)}</td>
                                <td class="text-end">${formatCurrency(lot.commission)}</td>
                                <td class="text-end">${currentValue !== null ? formatCurrency(currentValue) : 'N/A'}</td>
                                <td class="text-end ${pnlClass}">${lotPnl !== null ? formatCurrency(lotPnl) : 'N/A'}</td>
                                <td class="text-end ${pnlClass}">${lotPnlPercent !== null ? lotPnlPercent.toFixed(2) + '%' : 'N/A'}</td>
                            </tr>`;
        });
        
        detailHTML += `
                        </tbody>
                    </table>
                </div>`;
    } else {
        detailHTML += `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    No detailed lot information available for this position.
                </div>`;
    }
    
    // Add partial sales section placeholder
    detailHTML += `
                <div class="mt-3">
                    <h6>Partial Sales History</h6>
                    <div class="alert alert-secondary">
                        <i class="bi bi-clock me-2"></i>
                        Partial sales tracking coming soon. This will show realized P&L from partial position sales.
                    </div>
                </div>
            </div>
        </div>`;
    
    detailCell.innerHTML = detailHTML;
    detailRow.appendChild(detailCell);
    
    return detailRow;
}

function addExpandCollapseListeners() {
    // Use event delegation on the table to avoid duplicate listeners
    const positionsTable = document.getElementById('openPositionsTable');
    if (!positionsTable || positionsTable.hasAttribute('data-listeners-added')) {
        return; // Already has listeners or table not found
    }
    
    // Mark that we've added listeners to prevent duplicates
    positionsTable.setAttribute('data-listeners-added', 'true');
    
    positionsTable.addEventListener('click', function(event) {
        // Check if the clicked element is an expand arrow
        if (event.target.classList.contains('expand-arrow')) {
            const arrow = event.target;
            const symbol = arrow.getAttribute('data-symbol');
            const detailRow = document.getElementById(`detail-${symbol}`);
            
            if (detailRow) {
                const isExpanded = !detailRow.classList.contains('d-none');
                
                if (isExpanded) {
                    // Collapse
                    detailRow.classList.add('d-none');
                    arrow.classList.remove('bi-chevron-down');
                    arrow.classList.add('bi-chevron-right');
                    arrow.title = 'Click to view trade details';
                } else {
                    // Expand
                    detailRow.classList.remove('d-none');
                    arrow.classList.remove('bi-chevron-right');
                    arrow.classList.add('bi-chevron-down');
                    arrow.title = 'Click to hide trade details';
                }
            }
        }
    });
}

function updatePositionsWithFreshData(data) {
    // Update summary cards first
    updateSummaryCards(data.summary);
    
    // Check if risk ratio is applied for actions logic
    const riskRatioSelect = document.getElementById('riskRatioSelect');
    const isRiskRatioApplied = riskRatioSelect && riskRatioSelect.value !== 'none';
    
    // Store current expand/collapse states
    const expandStates = {};
    const expandArrows = document.querySelectorAll('.expand-arrow');
    expandArrows.forEach(arrow => {
        const symbol = arrow.getAttribute('data-symbol');
        const detailRow = document.getElementById(`detail-${symbol}`);
        if (detailRow) {
            expandStates[symbol] = !detailRow.classList.contains('d-none');
        }
    });
    
    // Update each position row with fresh data
    const positions = data.positions;
    
    positions.forEach(position => {
        const symbol = position.symbol;
        
        // Find the existing row
        const existingRows = document.querySelectorAll(`tr:not(.trade-detail-row)`);
        let targetRow = null;
        
        existingRows.forEach(row => {
            const symbolCell = row.querySelector('td:nth-child(2) strong');
            if (symbolCell && symbolCell.textContent === symbol) {
                targetRow = row;
            }
        });
        
        if (!targetRow) return; // Skip if row not found
        
        // Update price-dependent cells only
        const cells = targetRow.querySelectorAll('td');
        
        // Current Price (index 5)
        const currentPriceDisplay = position.current_price !== null && position.current_price !== undefined 
            ? `$${position.current_price.toFixed(4)}` 
            : '<span class="text-muted">Loading...</span>';
        cells[5].innerHTML = currentPriceDisplay;
        
        // Stop Loss (index 6)
        const positionStopLoss = position.stop_loss;
        let stopLossDisplay = '<span class="text-muted">Not Set</span>';
        if (positionStopLoss && positionStopLoss.price !== undefined && positionStopLoss.price !== null) {
            stopLossDisplay = `$${positionStopLoss.price.toFixed(4)}`;
            if (positionStopLoss.is_triggered) {
                stopLossDisplay += ' <span class="badge bg-danger ms-1">TRIGGERED</span>';
            }
        }
        cells[6].className = 'text-end';
        cells[6].innerHTML = stopLossDisplay;
        
        // Risk (index 7)
        let riskDisplay = '<span class="text-muted">-</span>';
        if (positionStopLoss && positionStopLoss.risk_amount !== undefined && positionStopLoss.risk_amount !== null) {
            riskDisplay = formatCurrency(positionStopLoss.risk_amount);
        }
        cells[7].className = 'text-end';
        cells[7].innerHTML = riskDisplay;
        
        // R-Multiple (index 8)
        const rMultiple = position.r_multiple;
        const rMultipleDisplay = rMultiple !== null && rMultiple !== undefined 
            ? `<span class="${rMultiple >= 0 ? 'text-success' : 'text-danger'}">${rMultiple.toFixed(2)}R</span>`
            : '<span class="text-muted">-</span>';
        cells[8].innerHTML = rMultipleDisplay;
        
        // SBE (index 9) - recalculate based on fresh price
        let sbeDisplay = '<span class="text-muted">-</span>';
        if (position.current_price !== null && position.current_price !== undefined && position.current_price > 0 && position.cost_basis) {
            const sharesToSell = Math.round(position.cost_basis / position.current_price);
            
            // Only show for profitable positions
            if (position.unrealized_pnl !== null && position.unrealized_pnl > 0) {
                if (sharesToSell > 0 && sharesToSell < position.quantity) {
                    sbeDisplay = `<span class="text-success fw-bold">${sharesToSell !== null && sharesToSell !== undefined && !isNaN(sharesToSell) ? sharesToSell.toLocaleString() : 'N/A'}</span>`;
                    // Add green highlighting for profitable positions
                    if (!targetRow.classList.contains('table-danger')) {
                        targetRow.classList.add('table-success');
                    }
                } else if (sharesToSell >= position.quantity) {
                    sbeDisplay = `<span class="text-warning" title="Current price $${position.current_price.toFixed(4)} requires selling all ${position.quantity} shares to break even.">All</span>`;
                } else {
                    sbeDisplay = '<span class="text-success">0</span>';
                }
            } else {
                sbeDisplay = '<span class="text-muted">-</span>';
            }
        }
        cells[9].innerHTML = sbeDisplay;
        
        // Unrealized P&L (index 11)
        const pnlDollar = position.unrealized_pnl;
        const pnlClass = pnlDollar !== null ? (pnlDollar >= 0 ? 'text-success' : 'text-danger') : '';
        cells[11].className = `text-end ${pnlClass}`;
        cells[11].innerHTML = pnlDollar !== null ? formatCurrency(pnlDollar) : 'N/A';
        
        // Remaining P&L % (index 12)
        const remainingPnlDisplay = position.unrealized_pnl_pct !== null && position.unrealized_pnl_pct !== undefined ? 
            `<span class="${position.unrealized_pnl_pct >= 0 ? 'text-success' : 'text-danger'}">
                ${formatPercentage(position.unrealized_pnl_pct)}
            </span>` : 'N/A';
        cells[12].innerHTML = remainingPnlDisplay;
        
        // Overall P&L % (index 13)
        const overallPnlDisplay = position.total_pnl_pct !== null && position.total_pnl_pct !== undefined ? 
            `<span class="${position.total_pnl_pct >= 0 ? 'text-success' : 'text-danger'}">
                ${formatPercentage(position.total_pnl_pct)}
            </span>` : 'N/A';
        cells[13].innerHTML = overallPnlDisplay;
        
        // Actions column (index 14) - update based on risk ratio state
        let actionsHtml = '';
        const positionStopLossInfo = position.stop_loss;
        
        if (isRiskRatioApplied) {
            // When risk ratio is applied, show auto-managed
            actionsHtml = '<span class="text-muted small">Auto-managed</span>';
        } else {
            // Individual management - show manual controls
            if (positionStopLossInfo) {
                actionsHtml = `
                    <button class="btn btn-sm btn-outline-danger" onclick="removeStopLoss('${position.symbol}')">Remove</button>
                    <button class="btn btn-sm btn-outline-secondary ms-1" onclick="showStopLossModal('${position.symbol}', ${position.avg_entry_price}, '${position.position_type}')">Edit</button>
                `;
            } else {
                actionsHtml = `<button class="btn btn-sm btn-outline-primary" onclick="showStopLossModal('${position.symbol}', ${position.avg_entry_price}, '${position.position_type}')">Set Stop</button>`;
            }
        }
        cells[14].innerHTML = actionsHtml;
        
        // Update the detail row if it exists and is expanded
        const detailRow = document.getElementById(`detail-${symbol}`);
        if (detailRow) {
            // Remove the old detail row
            detailRow.remove();
            
            // Create new detail row with fresh data
            const newDetailRow = createDetailRow(position);
            
            // Insert after the main row
            targetRow.parentNode.insertBefore(newDetailRow, targetRow.nextSibling);
            
            // Restore expand state if it was expanded
            if (expandStates[symbol]) {
                newDetailRow.classList.remove('d-none');
                const arrow = targetRow.querySelector('.expand-arrow');
                if (arrow) {
                    arrow.classList.remove('bi-chevron-right');
                    arrow.classList.add('bi-chevron-down');
                    arrow.title = 'Click to hide trade details';
                }
            }
        }
    });
    
    // Re-add event listeners for any new elements
    addExpandCollapseListeners();
}

function showLoadingState() {
    hideAllStates();
    const loading = document.getElementById('openPositionsLoading');
    if (loading) loading.classList.remove('d-none');
}

function showError(message) {
    hideAllStates();
    const errorMsg = document.getElementById('errorMessage');
    const errorDiv = document.getElementById('openPositionsError');
    
    if (errorMsg) errorMsg.textContent = message;
    if (errorDiv) errorDiv.classList.remove('d-none');
}

function hideAllStates() {
    const loading = document.getElementById('openPositionsLoading');
    const error = document.getElementById('openPositionsError');
    const noPositions = document.getElementById('noOpenPositions');
    const summary = document.getElementById('openPositionsSummary');
    const table = document.getElementById('openPositionsTable');
    
    if (loading) loading.classList.add('d-none');
    if (error) error.classList.add('d-none');
    if (noPositions) noPositions.classList.add('d-none');
    if (summary) summary.classList.add('d-none');
    if (table) table.classList.add('d-none');
}

function updateLastUpdated() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
}

function startAutoRefresh() {
    // Refresh every 30 seconds during market hours
    autoRefreshInterval = setInterval(() => {
        refreshPrices();
    }, 30000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

function formatCurrency(value) {
    if (value === null || value === undefined) {
        return 'N/A';
    }
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(value);
}

function formatPercentage(value) {
    if (value === null || value === undefined) {
        return 'N/A';
    }
    return `${value.toFixed(2)}%`;
}

// Stop Loss Modal Management
let currentPosition = null;

function showStopLossModal(symbol, entryPrice, positionType) {
    currentPosition = { symbol, entryPrice, positionType };
    
    // Update modal with position details
    document.getElementById('modalSymbol').textContent = symbol;
    document.getElementById('modalPositionType').textContent = positionType;
    document.getElementById('modalEntryPrice').textContent = `$${entryPrice.toFixed(4)}`;
    
    // Reset form
    document.getElementById('stopLossForm').reset();
    document.getElementById('stopTypeAmount').checked = true;
    updateStopTypeUI();
    
    // Clear preview
    clearStopLossPreview();
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('stopLossModal'));
    modal.show();
}

function updateStopTypeUI() {
    const isAmount = document.getElementById('stopTypeAmount').checked;
    const prefix = document.getElementById('stopValuePrefix');
    const suffix = document.getElementById('stopValueSuffix');
    const help = document.getElementById('stopValueHelp');
    
    if (isAmount) {
        prefix.textContent = '$';
        suffix.textContent = '';
        help.textContent = 'Enter the dollar amount to risk per share';
    } else {
        prefix.textContent = '';
        suffix.textContent = '%';
        help.textContent = 'Enter the percentage of entry price to risk';
    }
    
    // Clear and recalculate preview
    document.getElementById('stopValue').value = '';
    clearStopLossPreview();
}

function calculateStopLossPreview() {
    if (!currentPosition) return;
    
    const stopValue = parseFloat(document.getElementById('stopValue').value);
    if (isNaN(stopValue) || stopValue <= 0) {
        clearStopLossPreview();
        return;
    }
    
    const { symbol, entryPrice, positionType } = currentPosition;
    const isAmount = document.getElementById('stopTypeAmount').checked;
    
    let stopPrice;
    let riskPerShare;
    
    if (positionType.toLowerCase() === 'long') {
        if (isAmount) {
            stopPrice = entryPrice - stopValue;
            riskPerShare = stopValue;
        } else {
            stopPrice = entryPrice * (1 - stopValue / 100);
            riskPerShare = entryPrice - stopPrice;
        }
    } else { // short
        if (isAmount) {
            stopPrice = entryPrice + stopValue;
            riskPerShare = stopValue;
        } else {
            stopPrice = entryPrice * (1 + stopValue / 100);
            riskPerShare = stopPrice - entryPrice;
        }
    }
    
    // Find position to get quantity
    const positionsData = getStoredPositionsData();
    const position = positionsData.find(p => p.symbol === symbol);
    const quantity = position ? position.quantity : 0;
    const costBasis = position ? position.cost_basis : entryPrice * quantity;
    
    const totalRisk = riskPerShare * quantity;
    const riskPercentage = costBasis > 0 ? (totalRisk / costBasis * 100) : 0;
    
    // Update preview
    document.getElementById('previewStopPrice').textContent = `$${Math.max(0, stopPrice).toFixed(4)}`;
    document.getElementById('previewRiskPerShare').textContent = `$${riskPerShare.toFixed(4)}`;
    document.getElementById('previewTotalRisk').textContent = formatCurrency(totalRisk);
    document.getElementById('previewRiskPercentage').textContent = `${riskPercentage.toFixed(2)}%`;
}

function clearStopLossPreview() {
    document.getElementById('previewStopPrice').textContent = '-';
    document.getElementById('previewRiskPerShare').textContent = '-';
    document.getElementById('previewTotalRisk').textContent = '-';
    document.getElementById('previewRiskPercentage').textContent = '-';
}

function getStoredPositionsData() {
    // This is a simple way to get current positions data
    // In a real implementation, you might want to store this more robustly
    const tbody = document.getElementById('openPositionsTableBody');
    const positions = [];
    // This is a simplified version - in production you'd want to store the full data
    return window.lastPositionsData || [];
}

async function saveStopLoss() {
    if (!currentPosition) return;
    
    const stopValue = parseFloat(document.getElementById('stopValue').value);
    const stopType = document.getElementById('stopTypeAmount').checked ? 'amount' : 'percentage';
    
    if (isNaN(stopValue) || stopValue <= 0) {
        alert('Please enter a valid stop loss value.');
        return;
    }
    
    const saveBtn = document.getElementById('saveStopLossBtn');
    const originalText = saveBtn.innerHTML;
    
    try {
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Setting...';
        
        const response = await fetch(`/api/set-stop-loss/${SESSION_ID}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                symbol: currentPosition.symbol,
                stop_type: stopType,
                stop_value: stopValue
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('stopLossModal'));
            modal.hide();
            
            // Refresh positions to show updated stop loss
            await refreshPrices();
            
            // Show success message
            showNotification('success', `Stop loss set for ${currentPosition.symbol}`);
        } else {
            throw new Error(result.detail || 'Failed to set stop loss');
        }
        
    } catch (error) {
        console.error('Error setting stop loss:', error);
        showNotification('error', `Error setting stop loss: ${error.message}`);
    } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
    }
}

async function removeStopLoss(symbol) {
    if (!confirm(`Remove stop loss for ${symbol}?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/remove-stop-loss/${SESSION_ID}/${symbol}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Refresh positions
            await refreshPrices();
            showNotification('success', `Stop loss removed for ${symbol}`);
        } else {
            throw new Error(result.detail || 'Failed to remove stop loss');
        }
        
    } catch (error) {
        console.error('Error removing stop loss:', error);
        showNotification('error', `Error removing stop loss: ${error.message}`);
    }
}

function showNotification(type, message) {
    // Simple notification system
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        <i class="bi bi-${icon} me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

async function autoApplyRiskRatio() {
    const riskRatioSelect = document.getElementById('riskRatioSelect');
    const timePeriodSelect = document.getElementById('timePeriodSelect');
    const selectedRatio = riskRatioSelect.value;
    const selectedPeriod = timePeriodSelect.value;
    
    if (!selectedRatio || !selectedPeriod) {
        return; // Don't show error for auto-apply, just skip
    }
    
    // Add loading states to dropdowns
    riskRatioSelect.disabled = true;
    timePeriodSelect.disabled = true;
    riskRatioSelect.classList.add('loading');
    timePeriodSelect.classList.add('loading');
    
    try {
        const response = await fetch(`/api/apply-risk-ratio/${SESSION_ID}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                risk_ratio: selectedRatio,
                time_period: selectedPeriod
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Refresh positions to show updated stop losses (use faster endpoint)
            const positionsResponse = await fetch(`/api/open-positions/${SESSION_ID}`);
            if (positionsResponse.ok) {
                const positionsData = await positionsResponse.json();
                updatePositionsWithFreshData(positionsData);
                updateLastUpdated();
            } else {
                // Fallback to full refresh if fast update fails
                await refreshPrices();
            }
            
            // Show detailed success message
            showNotification('success', result.message);
            
            // Log details for debugging
            if (result.applied_count) {
                console.log(`Applied ${selectedRatio} ratio to ${result.applied_count} positions`);
                console.log(`Stop loss percentage: ${result.stop_loss_percentage?.toFixed(2)}%`);
                console.log(`Based on average gain: ${result.average_gain?.toFixed(2)}%`);
            }
        } else {
            throw new Error(result.detail || 'Failed to apply risk ratio');
        }
        
    } catch (error) {
        console.error('Error applying risk ratio:', error);
        showNotification('error', `Error applying risk ratio: ${error.message}`);
    } finally {
        // Remove loading states from dropdowns
        riskRatioSelect.disabled = false;
        timePeriodSelect.disabled = false;
        riskRatioSelect.classList.remove('loading');
        timePeriodSelect.classList.remove('loading');
    }
}

// ==================== Risk Calculator Logic ====================

const mode1Radio = document.getElementById('mode1');
const mode2Radio = document.getElementById('mode2');
const mode1Inputs = document.getElementById('mode1Inputs');
const mode2Inputs = document.getElementById('mode2Inputs');
const modeDescription = document.getElementById('modeDescription');

if (mode1Radio && mode2Radio) {
    mode1Radio.addEventListener('change', () => {
        mode1Inputs.classList.remove('d-none');
        mode2Inputs.classList.add('d-none');
        document.getElementById('riskResults').classList.add('d-none');
        modeDescription.textContent = 'Enter target position size % and stop loss % to calculate shares and risk amount';
    });

    mode2Radio.addEventListener('change', () => {
        mode1Inputs.classList.add('d-none');
        mode2Inputs.classList.remove('d-none');
        document.getElementById('riskResults').classList.add('d-none');
        modeDescription.textContent = 'Enter risk per trade % and stop loss % to calculate optimal position size';
    });
}

const calculateRiskBtn = document.getElementById('calculateRiskBtn');
if (calculateRiskBtn) {
    calculateRiskBtn.addEventListener('click', function() {
        const mode = document.querySelector('input[name="calcMode"]:checked').value;

        const symbol = document.getElementById('riskSymbol').value.trim();
        const entryPrice = parseFloat(document.getElementById('riskPrice').value);
        const portfolioSize = parseFloat(document.getElementById('riskPortfolio').value);

        if (!symbol) {
            alert('Please enter a symbol');
            return;
        }
        if (!entryPrice || entryPrice <= 0) {
            alert('Please enter a valid entry price');
            return;
        }
        if (!portfolioSize || portfolioSize <= 0) {
            alert('Please enter a valid portfolio size');
            return;
        }

        let results = {};

        if (mode === 'shares') {
            const targetPositionPct = parseFloat(document.getElementById('targetPositionPct').value);
            const stopLossPct = parseFloat(document.getElementById('stopLossPct').value);

            if (!targetPositionPct || targetPositionPct <= 0) {
                alert('Please enter a valid target position size %');
                return;
            }
            if (!stopLossPct || stopLossPct <= 0) {
                alert('Please enter a valid stop loss %');
                return;
            }

            results = calculateMode1(entryPrice, portfolioSize, targetPositionPct, stopLossPct);

        } else {
            const riskPerTradePct = parseFloat(document.getElementById('riskPerTradePct').value);
            const stopLossPct = parseFloat(document.getElementById('stopLossPctMode2').value);

            if (!riskPerTradePct || riskPerTradePct <= 0) {
                alert('Please enter a valid risk per trade %');
                return;
            }
            if (!stopLossPct || stopLossPct <= 0) {
                alert('Please enter a valid stop loss %');
                return;
            }

            results = calculateMode2(entryPrice, portfolioSize, riskPerTradePct, stopLossPct);
        }

        displayRiskResults(results);
    });
}

function calculateMode1(entryPrice, portfolioSize, targetPositionPct, stopLossPct) {
    const positionValue = (targetPositionPct / 100) * portfolioSize;
    const numShares = Math.floor(positionValue / entryPrice);
    const actualPositionValue = numShares * entryPrice;
    const actualPositionPct = (actualPositionValue / portfolioSize) * 100;
    const stopLossPrice = entryPrice * (1 - stopLossPct / 100);
    const riskPerShare = entryPrice - stopLossPrice;
    const riskAmount = numShares * riskPerShare;
    const riskPct = (riskAmount / portfolioSize) * 100;

    return {
        numShares,
        positionValue: actualPositionValue,
        positionPct: actualPositionPct,
        stopLossPrice,
        riskAmount,
        riskPct
    };
}

function calculateMode2(entryPrice, portfolioSize, riskPerTradePct, stopLossPct) {
    // NO CAP - Calculate based on risk amount
    const desiredRiskAmount = (riskPerTradePct / 100) * portfolioSize;
    const stopLossPrice = entryPrice * (1 - stopLossPct / 100);
    const riskPerShare = entryPrice - stopLossPrice;
    const numShares = Math.floor(desiredRiskAmount / riskPerShare);
    const positionValue = numShares * entryPrice;
    const positionPct = (positionValue / portfolioSize) * 100;
    const actualRiskAmount = numShares * riskPerShare;
    const actualRiskPct = (actualRiskAmount / portfolioSize) * 100;

    return {
        numShares,
        positionValue,
        positionPct,
        stopLossPrice,
        riskAmount: actualRiskAmount,
        riskPct: actualRiskPct
    };
}

function displayRiskResults(results) {
    document.getElementById('resultShares').textContent = results.numShares.toLocaleString();
    document.getElementById('resultPositionValue').textContent = formatCurrency(results.positionValue);
    document.getElementById('resultPositionPct').textContent = results.positionPct.toFixed(2) + '%';
    document.getElementById('resultRiskAmount').textContent = formatCurrency(results.riskAmount);
    document.getElementById('resultRiskPct').textContent = results.riskPct.toFixed(2) + '%';
    document.getElementById('resultStopPrice').textContent = '$' + results.stopLossPrice.toFixed(2);
    document.getElementById('riskResults').classList.remove('d-none');
}

// ==================== End Risk Calculator Logic ====================

</script>
<script>
const sessionId = '{{ session_id }}';
const performanceData = {{ data.performance | tojson }};

// Chart initialization moved to main event listener above

// Global chart instances
let performanceChart = null;
let winLossChart = null;

function initializeCharts() {
    // Destroy existing charts if they exist
    if (performanceChart) {
        performanceChart.destroy();
        performanceChart = null;
    }
    if (winLossChart) {
        winLossChart.destroy();
        winLossChart = null;
    }
    
    // Performance Over Time Chart
    if (performanceData.monthly && performanceData.monthly.length > 0) {
        const ctx1 = document.getElementById('performanceChart');
        if (ctx1) {
            performanceChart = new Chart(ctx1.getContext('2d'), {
            type: 'line',
            data: {
                labels: performanceData.monthly.map(d => d.Date),
                datasets: [{
                    label: 'Net Return (%)',
                    data: performanceData.monthly.map(d => d.Net),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Monthly Net Returns'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
            });
        }
    }

    // Win/Loss Distribution Chart
    if (performanceData.since_inception) {
        const ctx2 = document.getElementById('winLossChart');
        if (ctx2) {
            winLossChart = new Chart(ctx2.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Wins', 'Losses', 'Break-even'],
                datasets: [{
                    data: [
                        performanceData.since_inception.Wins || 0,
                        performanceData.since_inception.Losses || 0,
                        performanceData.since_inception['Break-even'] || 0
                    ],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Trade Distribution'
                    }
                }
            }
            });
        }
    }
}

function exportData(format, period) {
    window.location.href = `/export/${sessionId}?format=${format}&period=${period}`;
}
</script>
{% endblock %}