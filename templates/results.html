{% extends "base.html" %}

{% block title %}Results - Trading Performance Analyzer{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-primary">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Trading Performance Analysis
                </h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-file-earmark me-1"></i>
                    {% if data.files_count and data.files_count > 1 %}
                        Files ({{ data.files_count }}): {{ data.filename[:100] }}{% if data.filename|length > 100 %}...{% endif %}
                    {% else %}
                        File: {{ data.filename }}
                    {% endif %} |
                    <i class="bi bi-clock me-1"></i>
                    Processed: {{ data.upload_time[:19] | replace('T', ' ') }}
                </p>
            </div>
            <div>
                <a href="/" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i>
                    New Analysis
                </a>
            </div>
        </div>
    </div>

    <!-- Main Navigation Tabs -->
    <div class="col-12">
        <ul class="nav nav-tabs nav-tabs-lg" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="trades-performance-tab" data-bs-toggle="tab" data-bs-target="#trades-performance" type="button" role="tab">
                    <i class="bi bi-graph-up me-2"></i>Trades Performance
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="open-positions-tab" data-bs-toggle="tab" data-bs-target="#open-positions" type="button" role="tab">
                    <i class="bi bi-briefcase me-2"></i>Open Positions
                </button>
            </li>
        </ul>

        <!-- Main Tab Content -->
        <div class="tab-content" id="mainTabContent">
            <!-- Trades Performance Tab -->
            <div class="tab-pane fade show active" id="trades-performance" role="tabpanel">
                {% if data.performance.summary.total_trades > 0 %}
                <!-- Enhanced Summary Cards (5 Key Metrics) -->
                <div class="row mb-4 mt-4">
                    <!-- Top Row - 3 Cards -->
                    <div class="col-md-4">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-trophy text-primary display-4 mb-3"></i>
                                <h3 class="card-title text-primary">{{ "%.1f"|format(data.performance.summary.batting_average) }}%</h3>
                                <p class="card-text text-muted">Batting Average</p>
                                <small class="text-muted">Win Rate</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-graph-up-arrow text-success display-4 mb-3"></i>
                                <h3 class="card-title text-success">+{{ "%.2f"|format(data.performance.summary.average_gain) }}%</h3>
                                <p class="card-text text-muted">Average Gain</p>
                                <small class="text-muted">Winners Only</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-graph-down-arrow text-danger display-4 mb-3"></i>
                                <h3 class="card-title text-danger">-{{ "%.2f"|format(data.performance.summary.average_loss) }}%</h3>
                                <p class="card-text text-muted">Average Loss</p>
                                <small class="text-muted">Losers Only</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <!-- Bottom Row - 2 Cards -->
                    <div class="col-md-6">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-calculator text-info display-4 mb-3"></i>
                                <h3 class="card-title text-info">{{ "%.2f"|format(data.performance.summary.win_loss_ratio) }}</h3>
                                <p class="card-text text-muted">Win/Loss Ratio</p>
                                <small class="text-muted">Avg Gain รท Avg Loss</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card text-center h-100 summary-card">
                            <div class="card-body">
                                <i class="bi bi-gear text-warning display-4 mb-3"></i>
                                <h3 class="card-title text-warning">{{ "%.2f"|format(data.performance.summary.adjusted_win_loss_ratio) }}</h3>
                                <p class="card-text text-muted">Adjusted W/L Ratio</p>
                                <small class="text-muted">Accounts for Batting Avg</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Additional Info Card -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <h5 class="text-primary">{{ data.performance.summary.total_trades }}</h5>
                                        <small class="text-muted">Total Trades</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h5 class="{% if data.performance.summary.net_return >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(data.performance.summary.net_return) }}%
                                        </h5>
                                        <small class="text-muted">Net Return</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h5 class="text-success">{{ data.performance.since_inception.Wins }}</h5>
                                        <small class="text-muted">Winning Trades</small>
                                    </div>
                                    <div class="col-md-3">
                                        <h5 class="text-danger">{{ data.performance.since_inception.Losses }}</h5>
                                        <small class="text-muted">Losing Trades</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-graph-up me-2"></i>
                                    Performance Over Time
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-6">
                                        <canvas id="performanceChart" width="400" height="200"></canvas>
                                    </div>
                                    <div class="col-lg-6">
                                        <canvas id="winLossChart" width="400" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Performance Sub-tabs -->
                <div class="row">
                    <div class="col-12">
                        <ul class="nav nav-pills nav-fill" id="performanceSubTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                    <i class="bi bi-house me-1"></i>Since Inception
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab">
                                    <i class="bi bi-calendar-year me-1"></i>Yearly
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="quarterly-tab" data-bs-toggle="tab" data-bs-target="#quarterly" type="button" role="tab">
                                    <i class="bi bi-calendar3 me-1"></i>Quarterly
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">
                                    <i class="bi bi-calendar-month me-1"></i>Monthly
                                </button>
                            </li>
                        </ul>

                        <!-- Performance Sub-tab Content -->
                        <div class="tab-content mt-3" id="performanceSubTabContent">
                {% else %}
                <!-- No Closed Positions Message -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="alert alert-info text-center" role="alert">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>No Completed Trades</strong><br>
                            Your data contains open positions only. Switch to the <strong>"Open Positions"</strong> tab to view your current holdings and unrealized P&L.
                        </div>
                    </div>
                </div>
                {% endif %}
                            <!-- Since Inception Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Since Inception Performance</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="exportData('csv', 'since_inception')">
                                <i class="bi bi-download me-1"></i>CSV
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportData('excel', 'all')">
                                <i class="bi bi-file-earmark-excel me-1"></i>Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if data.performance.since_inception %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <tbody>
                                    <tr>
                                        <td><strong>Average Gain</strong></td>
                                        <td class="text-success">{{ "%.2f"|format(data.performance.since_inception['Avg Gain']) }}%</td>
                                        <td><strong>Average Loss</strong></td>
                                        <td class="text-danger">{{ "%.2f"|format(data.performance.since_inception['Avg Loss']) }}%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Net Return</strong></td>
                                        <td class="{% if data.performance.since_inception.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(data.performance.since_inception.Net) }}%
                                        </td>
                                        <td><strong>Win/Loss Ratio</strong></td>
                                        <td>{{ "%.2f"|format(data.performance.since_inception.Ratio) }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Wins</strong></td>
                                        <td class="text-success">{{ data.performance.since_inception.Wins }}</td>
                                        <td><strong>Losses</strong></td>
                                        <td class="text-danger">{{ data.performance.since_inception.Losses }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Largest Gain</strong></td>
                                        <td class="text-success">{{ "%.2f"|format(data.performance.since_inception['LG Gain']) }}%</td>
                                        <td><strong>Largest Loss</strong></td>
                                        <td class="text-danger">{{ "%.2f"|format(data.performance.since_inception['LG Loss']) }}%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Avg Days (Winners)</strong></td>
                                        <td>{{ data.performance.since_inception['Avg Days Gain'] }}</td>
                                        <td><strong>Avg Days (Losers)</strong></td>
                                        <td>{{ data.performance.since_inception['Avg Days Losses'] }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Commissions</strong></td>
                                        <td class="text-warning" colspan="3">${{ "%.2f"|format(data.performance.since_inception.COMM|abs) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

                            <!-- Yearly Tab -->
                            <div class="tab-pane fade" id="yearly" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Yearly Performance</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv', 'yearly')">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        {% if data.performance.yearly %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Year</th>
                                        <th>Net</th>
                                        <th>Win %</th>
                                        <th>Trades</th>
                                        <th>Avg Gain</th>
                                        <th>Avg Loss</th>
                                        <th>Ratio</th>
                                        <th>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data.performance.yearly %}
                                    <tr>
                                        <td><strong>{{ row.Date }}</strong></td>
                                        <td class="{% if row.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(row.Net) }}%
                                        </td>
                                        <td>{{ "%.1f"|format(row['Win %']) }}%</td>
                                        <td>{{ row['Total Trades'] }}</td>
                                        <td class="text-success">{{ "%.2f"|format(row['Avg Gain']) }}%</td>
                                        <td class="text-danger">{{ "%.2f"|format(row['Avg Loss']) }}%</td>
                                        <td>{{ "%.2f"|format(row.Ratio) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(row.COMM|abs) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No yearly data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

                            <!-- Quarterly Tab -->
                            <div class="tab-pane fade" id="quarterly" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Quarterly Performance</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv', 'quarterly')">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        {% if data.performance.quarterly %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Quarter</th>
                                        <th>Net</th>
                                        <th>Win %</th>
                                        <th>Trades</th>
                                        <th>Avg Gain</th>
                                        <th>Avg Loss</th>
                                        <th>Ratio</th>
                                        <th>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data.performance.quarterly %}
                                    <tr>
                                        <td><strong>{{ row.Date }}</strong></td>
                                        <td class="{% if row.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(row.Net) }}%
                                        </td>
                                        <td>{{ "%.1f"|format(row['Win %']) }}%</td>
                                        <td>{{ row['Total Trades'] }}</td>
                                        <td class="text-success">{{ "%.2f"|format(row['Avg Gain']) }}%</td>
                                        <td class="text-danger">{{ "%.2f"|format(row['Avg Loss']) }}%</td>
                                        <td>{{ "%.2f"|format(row.Ratio) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(row.COMM|abs) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No quarterly data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

                            <!-- Monthly Tab -->
                            <div class="tab-pane fade" id="monthly" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Monthly Performance</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv', 'monthly')">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        {% if data.performance.monthly %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Month</th>
                                        <th>Net</th>
                                        <th>Win %</th>
                                        <th>Trades</th>
                                        <th>Avg Gain</th>
                                        <th>Avg Loss</th>
                                        <th>Ratio</th>
                                        <th>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data.performance.monthly %}
                                    <tr>
                                        <td><strong>{{ row.Date }}</strong></td>
                                        <td class="{% if row.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(row.Net) }}%
                                        </td>
                                        <td>{{ "%.1f"|format(row['Win %']) }}%</td>
                                        <td>{{ row['Total Trades'] }}</td>
                                        <td class="text-success">{{ "%.2f"|format(row['Avg Gain']) }}%</td>
                                        <td class="text-danger">{{ "%.2f"|format(row['Avg Loss']) }}%</td>
                                        <td>{{ "%.2f"|format(row.Ratio) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(row.COMM|abs) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No monthly data available</p>
                        {% endif %}
                    </div>
                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Open Positions Tab -->
            <div class="tab-pane fade" id="open-positions" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-briefcase me-2"></i>Open Positions
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" id="refreshPricesBtn">
                                <i class="bi bi-arrow-clockwise me-1"></i>Refresh Prices
                            </button>
                            <small class="text-muted" id="lastUpdated"></small>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Loading State -->
                        <div id="openPositionsLoading" class="text-center py-4">
                            <div class="spinner-border text-primary me-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span>Loading open positions...</span>
                        </div>

                        <!-- Error State -->
                        <div id="openPositionsError" class="alert alert-danger d-none" role="alert">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="errorMessage">Error loading open positions</span>
                        </div>

                        <!-- No Positions State -->
                        <div id="noOpenPositions" class="text-center py-4 d-none">
                            <i class="bi bi-inbox display-4 text-muted mb-3"></i>
                            <h5 class="text-muted">No Open Positions</h5>
                            <p class="text-muted">All positions have been closed.</p>
                        </div>

                        <!-- Summary Cards -->
                        <div id="openPositionsSummary" class="d-none">
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-cash-stack text-primary display-6 mb-2"></i>
                                            <h6 class="card-title text-primary" id="totalMarketValue">$0.00</h6>
                                            <p class="card-text text-muted small">Market Value</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-piggy-bank text-secondary display-6 mb-2"></i>
                                            <h6 class="card-title text-secondary" id="totalCostBasis">$0.00</h6>
                                            <p class="card-text text-muted small">Cost Basis</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-graph-up-arrow display-6 mb-2" id="totalPnlIcon"></i>
                                            <h6 class="card-title" id="totalUnrealizedPnl">$0.00</h6>
                                            <p class="card-text text-muted small">Unrealized P&L</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center h-100 summary-card">
                                        <div class="card-body">
                                            <i class="bi bi-percent display-6 mb-2" id="overallPnlIcon"></i>
                                            <h6 class="card-title" id="overallPnlPct">0.00%</h6>
                                            <p class="card-text text-muted small">Overall %</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Positions Table -->
                        <div id="openPositionsTable" class="d-none">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Type</th>
                                            <th class="text-end">Quantity</th>
                                            <th class="text-end">Avg Price</th>
                                            <th class="text-end">Current Price</th>
                                            <th class="text-end">Cost Basis</th>
                                            <th class="text-end">Market Value</th>
                                            <th class="text-end">P&L ($)</th>
                                            <th class="text-end">P&L (%)</th>
                                            <th class="text-end">Orders</th>
                                        </tr>
                                    </thead>
                                    <tbody id="openPositionsTableBody">
                                        <!-- Positions will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Export Options -->
    <div class="col-12 mt-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-download me-2"></i>
                    Export Options
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Raw Data</h6>
                        <button class="btn btn-outline-secondary me-2 mb-2" onclick="exportData('roundtrips', 'all')">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>
                            Download Roundtrips CSV
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Performance Reports</h6>
                        <button class="btn btn-outline-success mb-2" onclick="exportData('excel', 'all')">
                            <i class="bi bi-file-earmark-excel me-1"></i>
                            Complete Excel Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global session ID
const SESSION_ID = '{{ session_id }}';

// Open Positions functionality
let autoRefreshInterval = null;

// Initialize tabs and functionality
document.addEventListener('DOMContentLoaded', function() {
    const tradesPerformanceTab = document.getElementById('trades-performance-tab');
    const openPositionsTab = document.getElementById('open-positions-tab');
    const refreshBtn = document.getElementById('refreshPricesBtn');
    
    // Initialize charts when trades performance tab is shown
    if (tradesPerformanceTab) {
        tradesPerformanceTab.addEventListener('shown.bs.tab', function() {
            // Small delay to ensure tab content is visible before initializing charts
            setTimeout(() => {
                initializeCharts();
            }, 100);
        });
    }
    
    // Initialize open positions when tab is shown
    if (openPositionsTab) {
        openPositionsTab.addEventListener('shown.bs.tab', function() {
            loadOpenPositions();
            startAutoRefresh();
        });
        
        openPositionsTab.addEventListener('hidden.bs.tab', function() {
            stopAutoRefresh();
        });
    }
    
    if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
            refreshPrices();
        });
    }
    
    // Initialize charts on page load (trades performance tab is active by default)
    setTimeout(() => {
        initializeCharts();
    }, 100);
});

async function loadOpenPositions() {
    showLoadingState();
    
    try {
        const response = await fetch(`/api/open-positions/${SESSION_ID}`);
        const data = await response.json();
        
        if (response.ok) {
            displayOpenPositions(data);
            updateLastUpdated();
        } else {
            showError(data.detail || 'Failed to load open positions');
        }
    } catch (error) {
        console.error('Error loading open positions:', error);
        showError('Network error loading open positions');
    }
}

async function refreshPrices() {
    const refreshBtn = document.getElementById('refreshPricesBtn');
    const originalContent = refreshBtn.innerHTML;
    
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1 spinner-border spinner-border-sm"></i>Refreshing...';
    
    try {
        const response = await fetch(`/api/refresh-prices/${SESSION_ID}`, {
            method: 'POST'
        });
        const data = await response.json();
        
        if (response.ok) {
            displayOpenPositions(data);
            updateLastUpdated();
        } else {
            showError(data.detail || 'Failed to refresh prices');
        }
    } catch (error) {
        console.error('Error refreshing prices:', error);
        showError('Network error refreshing prices');
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = originalContent;
    }
}

function displayOpenPositions(data) {
    hideAllStates();
    
    if (!data.positions || data.positions.length === 0) {
        document.getElementById('noOpenPositions').classList.remove('d-none');
        return;
    }
    
    // Show summary and table
    document.getElementById('openPositionsSummary').classList.remove('d-none');
    document.getElementById('openPositionsTable').classList.remove('d-none');
    
    // Update summary cards
    updateSummaryCards(data.summary);
    
    // Update positions table
    updatePositionsTable(data.positions);
}

function updateSummaryCards(summary) {
    // Total Market Value
    document.getElementById('totalMarketValue').textContent = formatCurrency(summary.total_market_value);
    
    // Total Cost Basis
    document.getElementById('totalCostBasis').textContent = formatCurrency(summary.total_cost_basis);
    
    // Total Unrealized P&L
    const totalPnl = summary.total_unrealized_pnl;
    const totalPnlElement = document.getElementById('totalUnrealizedPnl');
    const totalPnlIcon = document.getElementById('totalPnlIcon');
    
    totalPnlElement.textContent = formatCurrency(totalPnl);
    totalPnlElement.className = `card-title ${totalPnl >= 0 ? 'text-success' : 'text-danger'}`;
    totalPnlIcon.className = `bi ${totalPnl >= 0 ? 'bi-graph-up-arrow text-success' : 'bi-graph-down-arrow text-danger'} display-6 mb-2`;
    
    // Overall P&L %
    const overallPct = summary.overall_pnl_pct;
    const overallPctElement = document.getElementById('overallPnlPct');
    const overallPnlIcon = document.getElementById('overallPnlIcon');
    
    overallPctElement.textContent = formatPercentage(overallPct);
    overallPctElement.className = `card-title ${overallPct >= 0 ? 'text-success' : 'text-danger'}`;
    overallPnlIcon.className = `bi bi-percent ${overallPct >= 0 ? 'text-success' : 'text-danger'} display-6 mb-2`;
}

function updatePositionsTable(positions) {
    const tbody = document.getElementById('openPositionsTableBody');
    tbody.innerHTML = '';
    
    positions.forEach(position => {
        const row = document.createElement('tr');
        
        const pnlDollar = position.unrealized_pnl;
        const pnlPercent = position.unrealized_pnl_pct;
        const pnlClass = (pnlDollar >= 0) ? 'text-success' : 'text-danger';
        const currentPriceDisplay = position.current_price ? `$${position.current_price.toFixed(4)}` : 'N/A';
        
        row.innerHTML = `
            <td><strong>${position.symbol}</strong></td>
            <td>
                <span class="badge ${position.position_type === 'Long' ? 'bg-success' : 'bg-warning text-dark'}">
                    ${position.position_type}
                </span>
            </td>
            <td class="text-end">${position.quantity.toLocaleString()}</td>
            <td class="text-end">$${position.avg_entry_price.toFixed(4)}</td>
            <td class="text-end">${currentPriceDisplay}</td>
            <td class="text-end">${formatCurrency(position.cost_basis)}</td>
            <td class="text-end">${position.market_value ? formatCurrency(position.market_value) : 'N/A'}</td>
            <td class="text-end ${pnlClass}">
                ${pnlDollar !== null ? formatCurrency(pnlDollar) : 'N/A'}
            </td>
            <td class="text-end ${pnlClass}">
                ${pnlPercent !== null ? formatPercentage(pnlPercent) : 'N/A'}
            </td>
            <td class="text-end">${position.orders_count}</td>
        `;
        
        tbody.appendChild(row);
    });
}

function showLoadingState() {
    hideAllStates();
    document.getElementById('openPositionsLoading').classList.remove('d-none');
}

function showError(message) {
    hideAllStates();
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('openPositionsError').classList.remove('d-none');
}

function hideAllStates() {
    document.getElementById('openPositionsLoading').classList.add('d-none');
    document.getElementById('openPositionsError').classList.add('d-none');
    document.getElementById('noOpenPositions').classList.add('d-none');
    document.getElementById('openPositionsSummary').classList.add('d-none');
    document.getElementById('openPositionsTable').classList.add('d-none');
}

function updateLastUpdated() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    document.getElementById('lastUpdated').textContent = `Last updated: ${timeString}`;
}

function startAutoRefresh() {
    // Refresh every 30 seconds during market hours
    autoRefreshInterval = setInterval(() => {
        loadOpenPositions();
    }, 30000);
}

function stopAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
    }
}

function formatCurrency(value) {
    if (value === null || value === undefined) {
        return 'N/A';
    }
    return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(value);
}

function formatPercentage(value) {
    if (value === null || value === undefined) {
        return 'N/A';
    }
    return `${value.toFixed(2)}%`;
}
</script>
<script>
const sessionId = '{{ session_id }}';
const performanceData = {{ data.performance | tojson }};

// Chart initialization moved to main event listener above

// Global chart instances
let performanceChart = null;
let winLossChart = null;

function initializeCharts() {
    // Destroy existing charts if they exist
    if (performanceChart) {
        performanceChart.destroy();
        performanceChart = null;
    }
    if (winLossChart) {
        winLossChart.destroy();
        winLossChart = null;
    }
    
    // Performance Over Time Chart
    if (performanceData.monthly && performanceData.monthly.length > 0) {
        const ctx1 = document.getElementById('performanceChart');
        if (ctx1) {
            performanceChart = new Chart(ctx1.getContext('2d'), {
            type: 'line',
            data: {
                labels: performanceData.monthly.map(d => d.Date),
                datasets: [{
                    label: 'Net Return (%)',
                    data: performanceData.monthly.map(d => d.Net),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Monthly Net Returns'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
            });
        }
    }

    // Win/Loss Distribution Chart
    if (performanceData.since_inception) {
        const ctx2 = document.getElementById('winLossChart');
        if (ctx2) {
            winLossChart = new Chart(ctx2.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Wins', 'Losses', 'Break-even'],
                datasets: [{
                    data: [
                        performanceData.since_inception.Wins || 0,
                        performanceData.since_inception.Losses || 0,
                        performanceData.since_inception['Break-even'] || 0
                    ],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Trade Distribution'
                    }
                }
            }
            });
        }
    }
}

function exportData(format, period) {
    window.location.href = `/export/${sessionId}?format=${format}&period=${period}`;
}
</script>
{% endblock %}