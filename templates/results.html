{% extends "base.html" %}

{% block title %}Results - Trading Performance Analyzer{% endblock %}

{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-primary">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    Trading Performance Analysis
                </h2>
                <p class="text-muted mb-0">
                    <i class="bi bi-file-earmark me-1"></i>
                    File: {{ data.filename }} |
                    <i class="bi bi-clock me-1"></i>
                    Processed: {{ data.upload_time[:19] | replace('T', ' ') }}
                </p>
            </div>
            <div>
                <a href="/" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i>
                    New Analysis
                </a>
            </div>
        </div>
    </div>

    <!-- Enhanced Summary Cards (5 Key Metrics) -->
    <div class="col-12">
        <div class="row mb-4">
            <!-- Top Row - 3 Cards -->
            <div class="col-md-4">
                <div class="card text-center h-100 summary-card">
                    <div class="card-body">
                        <i class="bi bi-trophy text-primary display-4 mb-3"></i>
                        <h3 class="card-title text-primary">{{ "%.1f"|format(data.performance.summary.batting_average) }}%</h3>
                        <p class="card-text text-muted">Batting Average</p>
                        <small class="text-muted">Win Rate</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 summary-card">
                    <div class="card-body">
                        <i class="bi bi-graph-up-arrow text-success display-4 mb-3"></i>
                        <h3 class="card-title text-success">+{{ "%.2f"|format(data.performance.summary.average_gain) }}%</h3>
                        <p class="card-text text-muted">Average Gain</p>
                        <small class="text-muted">Winners Only</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card text-center h-100 summary-card">
                    <div class="card-body">
                        <i class="bi bi-graph-down-arrow text-danger display-4 mb-3"></i>
                        <h3 class="card-title text-danger">-{{ "%.2f"|format(data.performance.summary.average_loss) }}%</h3>
                        <p class="card-text text-muted">Average Loss</p>
                        <small class="text-muted">Losers Only</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <!-- Bottom Row - 2 Cards -->
            <div class="col-md-6">
                <div class="card text-center h-100 summary-card">
                    <div class="card-body">
                        <i class="bi bi-calculator text-info display-4 mb-3"></i>
                        <h3 class="card-title text-info">{{ "%.2f"|format(data.performance.summary.win_loss_ratio) }}</h3>
                        <p class="card-text text-muted">Win/Loss Ratio</p>
                        <small class="text-muted">Avg Gain รท Avg Loss</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card text-center h-100 summary-card">
                    <div class="card-body">
                        <i class="bi bi-gear text-warning display-4 mb-3"></i>
                        <h3 class="card-title text-warning">{{ "%.2f"|format(data.performance.summary.adjusted_win_loss_ratio) }}</h3>
                        <p class="card-text text-muted">Adjusted W/L Ratio</p>
                        <small class="text-muted">Accounts for Batting Avg</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Info Card -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <h5 class="text-primary">{{ data.performance.summary.total_trades }}</h5>
                                <small class="text-muted">Total Trades</small>
                            </div>
                            <div class="col-md-3">
                                <h5 class="{% if data.performance.summary.net_return >= 0 %}text-success{% else %}text-danger{% endif %}">
                                    {{ "%.2f"|format(data.performance.summary.net_return) }}%
                                </h5>
                                <small class="text-muted">Net Return</small>
                            </div>
                            <div class="col-md-3">
                                <h5 class="text-success">{{ data.performance.since_inception.Wins }}</h5>
                                <small class="text-muted">Winning Trades</small>
                            </div>
                            <div class="col-md-3">
                                <h5 class="text-danger">{{ data.performance.since_inception.Losses }}</h5>
                                <small class="text-muted">Losing Trades</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart Section -->
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-graph-up me-2"></i>
                    Performance Over Time
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <canvas id="performanceChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-lg-6">
                        <canvas id="winLossChart" width="400" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="col-12">
        <ul class="nav nav-tabs" id="resultsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                    <i class="bi bi-house me-1"></i>Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="yearly-tab" data-bs-toggle="tab" data-bs-target="#yearly" type="button" role="tab">
                    <i class="bi bi-calendar-year me-1"></i>Yearly
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="quarterly-tab" data-bs-toggle="tab" data-bs-target="#quarterly" type="button" role="tab">
                    <i class="bi bi-calendar3 me-1"></i>Quarterly
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="monthly-tab" data-bs-toggle="tab" data-bs-target="#monthly" type="button" role="tab">
                    <i class="bi bi-calendar-month me-1"></i>Monthly
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="resultsTabContent">
            <!-- Overview Tab -->
            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Since Inception Performance</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-2" onclick="exportData('csv', 'since_inception')">
                                <i class="bi bi-download me-1"></i>CSV
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="exportData('excel', 'all')">
                                <i class="bi bi-file-earmark-excel me-1"></i>Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if data.performance.since_inception %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <tbody>
                                    <tr>
                                        <td><strong>Average Gain</strong></td>
                                        <td class="text-success">{{ "%.2f"|format(data.performance.since_inception['Avg Gain']) }}%</td>
                                        <td><strong>Average Loss</strong></td>
                                        <td class="text-danger">{{ "%.2f"|format(data.performance.since_inception['Avg Loss']) }}%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Net Return</strong></td>
                                        <td class="{% if data.performance.since_inception.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(data.performance.since_inception.Net) }}%
                                        </td>
                                        <td><strong>Win/Loss Ratio</strong></td>
                                        <td>{{ "%.2f"|format(data.performance.since_inception.Ratio) }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Wins</strong></td>
                                        <td class="text-success">{{ data.performance.since_inception.Wins }}</td>
                                        <td><strong>Losses</strong></td>
                                        <td class="text-danger">{{ data.performance.since_inception.Losses }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Largest Gain</strong></td>
                                        <td class="text-success">{{ "%.2f"|format(data.performance.since_inception['LG Gain']) }}%</td>
                                        <td><strong>Largest Loss</strong></td>
                                        <td class="text-danger">{{ "%.2f"|format(data.performance.since_inception['LG Loss']) }}%</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Avg Days (Winners)</strong></td>
                                        <td>{{ data.performance.since_inception['Avg Days Gain'] }}</td>
                                        <td><strong>Avg Days (Losers)</strong></td>
                                        <td>{{ data.performance.since_inception['Avg Days Losses'] }}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total Commissions</strong></td>
                                        <td class="text-warning" colspan="3">${{ "%.2f"|format(data.performance.since_inception.COMM|abs) }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Yearly Tab -->
            <div class="tab-pane fade" id="yearly" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Yearly Performance</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv', 'yearly')">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        {% if data.performance.yearly %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Year</th>
                                        <th>Net</th>
                                        <th>Win %</th>
                                        <th>Trades</th>
                                        <th>Avg Gain</th>
                                        <th>Avg Loss</th>
                                        <th>Ratio</th>
                                        <th>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data.performance.yearly %}
                                    <tr>
                                        <td><strong>{{ row.Date }}</strong></td>
                                        <td class="{% if row.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(row.Net) }}%
                                        </td>
                                        <td>{{ "%.1f"|format(row['Win %']) }}%</td>
                                        <td>{{ row['# Trades'] }}</td>
                                        <td class="text-success">{{ "%.2f"|format(row['Avg Gain']) }}%</td>
                                        <td class="text-danger">{{ "%.2f"|format(row['Avg Loss']) }}%</td>
                                        <td>{{ "%.2f"|format(row.Ratio) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(row.COMM|abs) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No yearly data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quarterly Tab -->
            <div class="tab-pane fade" id="quarterly" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Quarterly Performance</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv', 'quarterly')">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        {% if data.performance.quarterly %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Quarter</th>
                                        <th>Net</th>
                                        <th>Win %</th>
                                        <th>Trades</th>
                                        <th>Avg Gain</th>
                                        <th>Avg Loss</th>
                                        <th>Ratio</th>
                                        <th>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data.performance.quarterly %}
                                    <tr>
                                        <td><strong>{{ row.Date }}</strong></td>
                                        <td class="{% if row.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(row.Net) }}%
                                        </td>
                                        <td>{{ "%.1f"|format(row['Win %']) }}%</td>
                                        <td>{{ row['# Trades'] }}</td>
                                        <td class="text-success">{{ "%.2f"|format(row['Avg Gain']) }}%</td>
                                        <td class="text-danger">{{ "%.2f"|format(row['Avg Loss']) }}%</td>
                                        <td>{{ "%.2f"|format(row.Ratio) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(row.COMM|abs) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No quarterly data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Monthly Tab -->
            <div class="tab-pane fade" id="monthly" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Monthly Performance</h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="exportData('csv', 'monthly')">
                            <i class="bi bi-download me-1"></i>Export CSV
                        </button>
                    </div>
                    <div class="card-body">
                        {% if data.performance.monthly %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Month</th>
                                        <th>Net</th>
                                        <th>Win %</th>
                                        <th>Trades</th>
                                        <th>Avg Gain</th>
                                        <th>Avg Loss</th>
                                        <th>Ratio</th>
                                        <th>Commission</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in data.performance.monthly %}
                                    <tr>
                                        <td><strong>{{ row.Date }}</strong></td>
                                        <td class="{% if row.Net >= 0 %}text-success{% else %}text-danger{% endif %}">
                                            {{ "%.2f"|format(row.Net) }}%
                                        </td>
                                        <td>{{ "%.1f"|format(row['Win %']) }}%</td>
                                        <td>{{ row['# Trades'] }}</td>
                                        <td class="text-success">{{ "%.2f"|format(row['Avg Gain']) }}%</td>
                                        <td class="text-danger">{{ "%.2f"|format(row['Avg Loss']) }}%</td>
                                        <td>{{ "%.2f"|format(row.Ratio) }}</td>
                                        <td class="text-warning">${{ "%.2f"|format(row.COMM|abs) }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No monthly data available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Export Options -->
    <div class="col-12 mt-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-download me-2"></i>
                    Export Options
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Raw Data</h6>
                        <button class="btn btn-outline-secondary me-2 mb-2" onclick="exportData('roundtrips', 'all')">
                            <i class="bi bi-file-earmark-spreadsheet me-1"></i>
                            Download Roundtrips CSV
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Performance Reports</h6>
                        <button class="btn btn-outline-success mb-2" onclick="exportData('excel', 'all')">
                            <i class="bi bi-file-earmark-excel me-1"></i>
                            Complete Excel Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const sessionId = '{{ session_id }}';
const performanceData = {{ data.performance | tojson }};

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    // Performance Over Time Chart
    if (performanceData.monthly && performanceData.monthly.length > 0) {
        const ctx1 = document.getElementById('performanceChart').getContext('2d');
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: performanceData.monthly.map(d => d.Date),
                datasets: [{
                    label: 'Net Return (%)',
                    data: performanceData.monthly.map(d => d.Net),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Monthly Net Returns'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }

    // Win/Loss Distribution Chart
    if (performanceData.since_inception) {
        const ctx2 = document.getElementById('winLossChart').getContext('2d');
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: ['Wins', 'Losses', 'Break-even'],
                datasets: [{
                    data: [
                        performanceData.since_inception.Wins || 0,
                        performanceData.since_inception.Losses || 0,
                        performanceData.since_inception['Break-even'] || 0
                    ],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Trade Distribution'
                    }
                }
            }
        });
    }
}

function exportData(format, period) {
    window.location.href = `/export/${sessionId}?format=${format}&period=${period}`;
}
</script>
{% endblock %}