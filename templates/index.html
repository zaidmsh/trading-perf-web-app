{% extends "base.html" %}

{% block title %}Upload IBKR CSV - Trading Performance Analyzer{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Hero Section -->
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">Trading Performance Analyzer</h1>
            <p class="lead text-muted">Upload your IBKR trades CSV to analyze your trading performance with detailed metrics and visualizations.</p>
        </div>

        <!-- Data Source Selection Card -->
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="bi bi-database me-2"></i>
                    Select Data Source
                </h5>
            </div>
            <div class="card-body">
                <!-- Data Source Selection -->
                <div class="mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dataSource" id="sourceCSV" value="csv" checked>
                                <label class="form-check-label" for="sourceCSV">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    <strong>CSV Only</strong>
                                </label>
                                <div class="form-text">Upload CSV files manually</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dataSource" id="sourceIBKR" value="ibkr">
                                <label class="form-check-label" for="sourceIBKR">
                                    <i class="bi bi-cloud-download me-2"></i>
                                    <strong>IBKR Only</strong>
                                </label>
                                <div class="form-text">Fetch current year from IBKR</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="dataSource" id="sourceHybrid" value="hybrid">
                                <label class="form-check-label" for="sourceHybrid">
                                    <i class="bi bi-layers me-2"></i>
                                    <strong>CSV + IBKR</strong>
                                </label>
                                <div class="form-text">Combine historical CSV with current IBKR</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CSV Upload Section -->
                <div id="csvSection">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Select CSV Files (Multiple files supported)</label>
                            <input class="form-control" type="file" id="csvFile" name="files" accept=".csv" multiple required>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Select multiple CSV files to analyze multi-year performance. Max 10MB per file.
                            </div>
                        </div>

                        <!-- Drag and Drop Area -->
                        <div id="dropArea" class="border-2 border-dashed border-secondary rounded p-4 text-center text-muted mb-3">
                            <i class="bi bi-cloud-upload display-4 mb-3"></i>
                            <p class="mb-2">Drag and drop your CSV files here</p>
                            <p class="small">or click browse to select files (multiple files supported)</p>
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="uploadBtn">
                            <i class="bi bi-upload me-2"></i>
                            Analyze Performance
                        </button>
                    </form>
                </div>

                <!-- IBKR API Section -->
                <div id="ibkrSection" style="display: none;">
                    <form id="ibkrForm">
                        <div class="mb-3">
                            <label for="flexToken" class="form-label">FlexQuery Token</label>
                            <input type="password" class="form-control" id="flexToken" placeholder="Enter your FlexQuery token" required>
                            <div class="form-text">
                                <i class="bi bi-shield-lock me-1"></i>
                                Your token is used only for this session and not stored
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="queryId" class="form-label">Query ID</label>
                            <input type="text" class="form-control" id="queryId" placeholder="Enter your Query ID" required>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                The ID of your pre-configured FlexQuery
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="startYear" class="form-label">Start Year (Optional)</label>
                            <input type="number" class="form-control" id="startYear" placeholder="e.g., 2020" min="2000" max="2025">
                            <div class="form-text">
                                <i class="bi bi-calendar-range me-1"></i>
                                Leave empty for current year only, or specify year to fetch historical data (e.g., 2020)
                            </div>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-secondary me-2" id="testConnectionBtn">
                                <i class="bi bi-wifi me-2"></i>
                                Test Connection
                            </button>
                            <small id="connectionStatus" class="text-muted"></small>
                        </div>

                        <button type="submit" class="btn btn-primary w-100" id="fetchBtn">
                            <i class="bi bi-cloud-download me-2"></i>
                            Fetch & Analyze Trades
                        </button>
                    </form>
                </div>

                <!-- Hybrid Upload Section -->
                <div id="hybridSection" style="display: none;">
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Hybrid Mode:</strong> Upload CSV files for historical data, then we'll automatically fetch current year from IBKR and combine everything with duplicate removal.
                    </div>

                    <form id="hybridForm" enctype="multipart/form-data">
                        <!-- CSV Files for Historical Data -->
                        <div class="mb-3">
                            <label for="hybridCsvFile" class="form-label">Historical CSV Files</label>
                            <input class="form-control" type="file" id="hybridCsvFile" name="files" accept=".csv" multiple required>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Upload CSV files for previous years (2020, 2021, 2022, etc.)
                            </div>
                        </div>

                        <!-- Drag and Drop Area -->
                        <div id="hybridDropArea" class="border-2 border-dashed border-secondary rounded p-4 text-center text-muted mb-3">
                            <i class="bi bi-cloud-upload display-4 mb-3"></i>
                            <p class="mb-2">Drag and drop your historical CSV files here</p>
                            <p class="small">We'll combine these with current IBKR data automatically</p>
                        </div>

                        <!-- IBKR Credentials -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hybridFlexToken" class="form-label">FlexQuery Token</label>
                                    <input type="password" class="form-control" id="hybridFlexToken" placeholder="Enter your FlexQuery token" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="hybridQueryId" class="form-label">Query ID</label>
                                    <input type="text" class="form-control" id="hybridQueryId" placeholder="Enter your Query ID" required>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success w-100" id="hybridBtn">
                            <i class="bi bi-layers me-2"></i>
                            Combine Historical CSV + Current IBKR Data
                        </button>
                    </form>
                </div>

                <!-- Progress Bar -->
                <div class="mt-3">
                    <div id="progressContainer" class="d-none">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <small id="progressText" class="text-muted">Processing...</small>
                        </div>
                    </div>
                </div>

                <!-- Alert Area -->
                <div id="alertArea" class="mt-3"></div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="card h-100 border-0">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up text-primary display-4 mb-3"></i>
                        <h5 class="card-title">Performance Metrics</h5>
                        <p class="card-text text-muted">Detailed analysis of your trading performance including win rates, profit/loss ratios, and more.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar3 text-primary display-4 mb-3"></i>
                        <h5 class="card-title">Time-Based Analysis</h5>
                        <p class="card-text text-muted">View your performance across different time periods: monthly, quarterly, and yearly.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0">
                    <div class="card-body text-center">
                        <i class="bi bi-download text-primary display-4 mb-3"></i>
                        <h5 class="card-title">Export Options</h5>
                        <p class="card-text text-muted">Export your results to CSV, Excel, or generate comprehensive PDF reports.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- IBKR FlexQuery Setup Instructions -->
        <div class="card mt-5">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear me-2"></i>
                    How to Setup IBKR FlexQuery
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>One-time setup required for automatic data fetching:</strong>
                </div>
                <ol class="mb-3">
                    <li class="mb-2">
                        <strong>Log into IBKR Account Management</strong>
                        <div class="text-muted small">Go to <code>Reports → Flex Queries</code></div>
                    </li>
                    <li class="mb-2">
                        <strong>Create Activity Flex Query</strong>
                        <div class="text-muted small">Include: Trades, Executions, and make sure to select all stock transactions</div>
                    </li>
                    <li class="mb-2">
                        <strong>Note the Query ID</strong>
                        <div class="text-muted small">Copy the generated Query ID for later use</div>
                    </li>
                    <li class="mb-2">
                        <strong>Enable FlexQuery Web Service</strong>
                        <div class="text-muted small">Go to <code>Reports → Settings → FlexQuery Web Service</code> and generate a token</div>
                    </li>
                </ol>
                <div class="alert alert-warning">
                    <small><i class="bi bi-shield-lock me-1"></i>Your credentials are only used for the current session and are never stored on our servers.</small>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card mt-5">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-question-circle me-2"></i>
                    How to Use
                </h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">
                        <strong>Choose your data source:</strong>
                        Upload CSV files manually or fetch trades automatically from IBKR using FlexQuery API.
                    </li>
                    <li class="mb-2">
                        <strong>For CSV uploads:</strong>
                        Export your trades from IBKR and upload CSV files. Required columns: Symbol, TradeDate, Quantity, Price, Commission, Buy/Sell.
                    </li>
                    <li class="mb-2">
                        <strong>For IBKR API:</strong>
                        Setup FlexQuery (see instructions above), then enter your token and query ID to fetch trades automatically.
                    </li>
                    <li>
                        <strong>View results:</strong>
                        Once processed, you'll be redirected to a detailed results page with charts, tables, and export options.
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const uploadForm = document.getElementById('uploadForm');
    const ibkrForm = document.getElementById('ibkrForm');
    const fileInput = document.getElementById('csvFile');
    const dropArea = document.getElementById('dropArea');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const alertArea = document.getElementById('alertArea');
    const uploadBtn = document.getElementById('uploadBtn');
    const fetchBtn = document.getElementById('fetchBtn');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const connectionStatus = document.getElementById('connectionStatus');

    // Data source selection elements
    const csvSection = document.getElementById('csvSection');
    const ibkrSection = document.getElementById('ibkrSection');
    const hybridSection = document.getElementById('hybridSection');
    const sourceRadios = document.querySelectorAll('input[name="dataSource"]');

    // Data source toggle functionality
    sourceRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            // Hide all sections first
            csvSection.style.display = 'none';
            ibkrSection.style.display = 'none';
            hybridSection.style.display = 'none';
            hideProgress();

            // Show the selected section
            if (e.target.value === 'csv') {
                csvSection.style.display = 'block';
            } else if (e.target.value === 'ibkr') {
                ibkrSection.style.display = 'block';
            } else if (e.target.value === 'hybrid') {
                hybridSection.style.display = 'block';
            }
        });
    });

    // CSV Upload functionality (existing logic)
    if (dropArea && fileInput) {
        // Drag and drop functionality
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('border-primary');
        });

        dropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropArea.classList.remove('border-primary');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('border-primary');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        // Click to browse
        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                let invalidFiles = [];
                let largeFiles = [];

                files.forEach(file => {
                    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                        invalidFiles.push(file.name);
                    }
                    if (file.size > 10 * 1024 * 1024) { // 10MB
                        largeFiles.push(file.name);
                    }
                });

                if (invalidFiles.length > 0) {
                    showAlert(`Non-CSV files detected: ${invalidFiles.join(', ')}. Please select only CSV files.`, 'warning');
                    fileInput.value = '';
                    return;
                }

                if (largeFiles.length > 0) {
                    showAlert(`Files too large (>10MB): ${largeFiles.join(', ')}`, 'warning');
                    fileInput.value = '';
                    return;
                }

                const fileNames = files.map(f => f.name).join(', ');
                updateDropAreaText(`Selected ${files.length} file(s): ${fileNames}`);
            }
        });
    }

    // CSV form submission
    if (uploadForm) {
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const files = fileInput.files;
            if (!files || files.length === 0) {
                showAlert('Please select at least one CSV file.', 'warning');
                return;
            }

            showProgress('Processing your CSV files...');

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(result.message, 'success');
                    setTimeout(() => {
                        window.location.href = `/results/${result.session_id}`;
                    }, 1500);
                } else {
                    showAlert(result.detail || 'Upload failed', 'danger');
                    hideProgress();
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'danger');
                hideProgress();
            }
        });
    }

    // IBKR test connection
    if (testConnectionBtn) {
        testConnectionBtn.addEventListener('click', async () => {
            const token = document.getElementById('flexToken').value;
            const queryId = document.getElementById('queryId').value;

            if (!token || !queryId) {
                showAlert('Please enter both FlexQuery token and Query ID.', 'warning');
                return;
            }

            testConnectionBtn.disabled = true;
            connectionStatus.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Testing...';

            try {
                const response = await fetch('/api/test-ibkr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        query_id: queryId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    connectionStatus.innerHTML = '<i class="bi bi-check-circle text-success me-1"></i>' + result.message;
                } else {
                    connectionStatus.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i>' + result.message;
                }
            } catch (error) {
                connectionStatus.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i>Connection test failed';
            } finally {
                testConnectionBtn.disabled = false;
            }
        });
    }

    // IBKR form submission
    if (ibkrForm) {
        ibkrForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = document.getElementById('flexToken').value;
            const queryId = document.getElementById('queryId').value;
            const startYear = document.getElementById('startYear').value;

            if (!token || !queryId) {
                showAlert('Please enter both FlexQuery token and Query ID.', 'warning');
                return;
            }

            // Update progress message based on whether historical data is requested
            const progressMessage = startYear ?
                `Fetching historical trades from IBKR (${startYear}-present)...` :
                'Fetching trades from IBKR...';
            showProgress(progressMessage);

            const requestBody = {
                token: token,
                query_id: queryId
            };

            // Add start_year if provided
            if (startYear) {
                requestBody.start_year = parseInt(startYear);
            }

            try {
                const response = await fetch('/api/fetch-ibkr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(result.message, 'success');
                    setTimeout(() => {
                        window.location.href = `/results/${result.session_id}`;
                    }, 1500);
                } else {
                    showAlert(result.detail || 'Fetch failed', 'danger');
                    hideProgress();
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'danger');
                hideProgress();
            }
        });
    }

    // Hybrid form elements
    const hybridForm = document.getElementById('hybridForm');
    const hybridFileInput = document.getElementById('hybridCsvFile');
    const hybridDropArea = document.getElementById('hybridDropArea');
    const hybridBtn = document.getElementById('hybridBtn');

    // Hybrid drag and drop functionality
    if (hybridDropArea && hybridFileInput) {
        hybridDropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            hybridDropArea.classList.add('border-primary');
        });

        hybridDropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            hybridDropArea.classList.remove('border-primary');
        });

        hybridDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            hybridDropArea.classList.remove('border-primary');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                hybridFileInput.files = files;
                hybridFileInput.dispatchEvent(new Event('change'));
            }
        });

        hybridDropArea.addEventListener('click', () => {
            hybridFileInput.click();
        });

        hybridFileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                const fileNames = files.map(f => f.name).join(', ');
                updateHybridDropAreaText(`Selected ${files.length} historical file(s): ${fileNames}`);
            }
        });
    }

    // Hybrid form submission
    if (hybridForm) {
        hybridForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const files = hybridFileInput.files;
            const token = document.getElementById('hybridFlexToken').value;
            const queryId = document.getElementById('hybridQueryId').value;

            if (!files || files.length === 0) {
                showAlert('Please select at least one CSV file for historical data.', 'warning');
                return;
            }

            if (!token || !queryId) {
                showAlert('Please enter both FlexQuery token and Query ID.', 'warning');
                return;
            }

            showProgress(`Combining ${files.length} historical CSV file(s) with current IBKR data...`);

            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }

            try {
                const response = await fetch(`/api/hybrid-upload?token=${encodeURIComponent(token)}&query_id=${encodeURIComponent(queryId)}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(result.message, 'success');
                    setTimeout(() => {
                        window.location.href = `/results/${result.session_id}`;
                    }, 1500);
                } else {
                    showAlert(result.detail || 'Hybrid upload failed', 'danger');
                    hideProgress();
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'danger');
                hideProgress();
            }
        });
    }

    // Utility functions
    function showProgress(message = 'Processing...') {
        progressContainer.classList.remove('d-none');
        if (uploadBtn) uploadBtn.disabled = true;
        if (fetchBtn) fetchBtn.disabled = true;
        progressBar.style.width = '100%';
        progressText.textContent = message;
    }

    function hideProgress() {
        progressContainer.classList.add('d-none');
        if (uploadBtn) uploadBtn.disabled = false;
        if (fetchBtn) fetchBtn.disabled = false;
        progressBar.style.width = '0%';
    }

    function showAlert(message, type) {
        alertArea.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    function updateDropAreaText(text) {
        if (dropArea) {
            dropArea.innerHTML = `
                <i class="bi bi-file-earmark-check display-4 mb-3 text-success"></i>
                <p class="mb-2">${text}</p>
                <p class="small text-muted">Click to select different files</p>
            `;
        }
    }

    function updateHybridDropAreaText(text) {
        if (hybridDropArea) {
            hybridDropArea.innerHTML = `
                <i class="bi bi-file-earmark-check display-4 mb-3 text-success"></i>
                <p class="mb-2">${text}</p>
                <p class="small text-muted">Click to select different files</p>
            `;
        }
    }
});
</script>
{% endblock %}