{% extends "base.html" %}

{% block title %}Upload IBKR CSV - Trading Performance Analyzer{% endblock %}

{% block extra_styles %}
<style>
/* Fix card header visibility - darker blue background for better contrast */
.card-header.bg-primary {
    background-color: #0a58ca !important; /* Darker blue */
    color: #ffffff !important;
}

.card-header.bg-primary .card-title,
.card-header.bg-primary h5,
.card-header.bg-primary i {
    color: #ffffff !important;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0,0,0,0.2); /* Add subtle shadow for better readability */
}

.result-item {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #0d6efd;
    transition: all 0.3s ease;
}

.result-item:hover {
    background: #e9ecef;
    transform: translateX(3px);
}

.result-item small {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
}

.btn-group label {
    white-space: nowrap;
    padding: 10px 20px;
}

.mode-inputs {
    transition: opacity 0.3s ease;
}

#riskResults {
    animation: slideIn 0.4s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Hero Section -->
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">Trading Performance Analyzer</h1>
            <p class="lead text-muted">Upload your IBKR trades CSV to analyze your trading performance with detailed metrics and visualizations.</p>
        </div>

        <!-- Data Source Selection Card -->
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-database me-2"></i>
                    Select Data Source
                </h5>
            </div>
            <div class="card-body">
                <!-- Hybrid Input Information -->
                <div class="mb-4">
                    <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-2"></i>
                        <strong>Flexible Input:</strong> Provide CSV files, IBKR credentials, or both. The system will automatically analyze whatever data you provide.
                        <ul class="mb-0 mt-2">
                            <li><strong>CSV only:</strong> Upload CSV files to analyze historical data</li>
                            <li><strong>IBKR only:</strong> Enter credentials to fetch current/historical data from IBKR</li>
                            <li><strong>Both:</strong> Combine CSV files with IBKR data for comprehensive analysis</li>
                        </ul>
                        <div class="mt-2"><strong>Note:</strong> At least one input method is required.</div>
                    </div>
                </div>

                <!-- Unified Hybrid Form -->
                <form id="hybridForm" enctype="multipart/form-data">
                    <!-- CSV Upload Section -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="bi bi-file-earmark-text me-2"></i>
                            CSV Files <span class="text-muted">(Optional)</span>
                        </h6>
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Select CSV Files</label>
                            <input class="form-control" type="file" id="csvFile" name="files" accept=".csv" multiple>
                            <div class="form-text">
                                <i class="bi bi-info-circle me-1"></i>
                                Upload multiple CSV files for historical data analysis. Max 10MB per file.
                            </div>
                        </div>

                        <!-- Drag and Drop Area -->
                        <div id="dropArea" class="border-2 border-dashed border-secondary rounded p-4 text-center text-muted mb-3">
                            <i class="bi bi-cloud-upload display-4 mb-3"></i>
                            <p class="mb-2">Drag and drop your CSV files here</p>
                            <p class="small">or click browse to select files (optional)</p>
                        </div>
                    </div>

                    <!-- IBKR API Section -->
                    <div class="mb-4">
                        <h6 class="mb-3">
                            <i class="bi bi-cloud-download me-2"></i>
                            IBKR FlexQuery <span class="text-muted">(Optional)</span>
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="flexToken" class="form-label">FlexQuery Token</label>
                                    <input type="password" class="form-control" id="flexToken" placeholder="Enter your FlexQuery token">
                                    <div class="form-text">
                                        <i class="bi bi-shield-lock me-1"></i>
                                        Your token is used only for this session and not stored
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="queryId" class="form-label">Query ID</label>
                                    <input type="text" class="form-control" id="queryId" placeholder="Enter your Query ID">
                                    <div class="form-text">
                                        <i class="bi bi-info-circle me-1"></i>
                                        The ID of your pre-configured FlexQuery
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="startYear" class="form-label">Start Year (Optional)</label>
                            <input type="number" class="form-control" id="startYear" placeholder="e.g., 2020" min="2000" max="2025">
                            <div class="form-text">
                                <i class="bi bi-calendar-range me-1"></i>
                                Leave empty for current year only, or specify year to fetch historical data (e.g., 2020)
                            </div>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-secondary me-2" id="testConnectionBtn">
                                <i class="bi bi-wifi me-2"></i>
                                Test Connection
                            </button>
                            <small id="connectionStatus" class="text-muted"></small>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100" id="analyzeBtn">
                        <i class="bi bi-graph-up me-2"></i>
                        Analyze Trading Performance
                    </button>
                </form>


                <!-- Progress Bar -->
                <div class="mt-3">
                    <div id="progressContainer" class="d-none">
                        <div class="progress">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-center mt-2">
                            <small id="progressText" class="text-muted">Processing...</small>
                        </div>
                    </div>
                </div>

                <!-- Alert Area -->
                <div id="alertArea" class="mt-3"></div>
            </div>
        </div>

        <!-- Risk Calculator Section -->
        <div class="card shadow-sm mt-5">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calculator me-2"></i>
                    Risk Calculator
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">Calculate optimal position sizing based on your risk management strategy.</p>

                <!-- Mode Selector -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Calculation Mode:</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="calcMode" id="mode1" value="shares" checked>
                        <label class="btn btn-outline-primary" for="mode1">
                            <i class="bi bi-123"></i> Calculate Shares & Risk
                        </label>
                        <input type="radio" class="btn-check" name="calcMode" id="mode2" value="risk">
                        <label class="btn btn-outline-primary" for="mode2">
                            <i class="bi bi-pie-chart"></i> Calculate Position Size
                        </label>
                    </div>
                    <small class="text-muted d-block mt-2" id="modeDescription">
                        Enter target position size % and stop loss % to calculate shares and risk amount
                    </small>
                </div>

                <!-- Common Inputs -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label class="form-label">Symbol</label>
                        <input type="text" id="riskSymbol" class="form-control" placeholder="AAPL">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Entry Price ($)</label>
                        <input type="number" id="riskPrice" class="form-control" step="0.01" min="0.01" placeholder="100.00">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Portfolio Size ($)</label>
                        <input type="number" id="riskPortfolio" class="form-control" step="0.01" min="1" placeholder="100000">
                    </div>
                </div>

                <!-- Mode 1 Inputs -->
                <div id="mode1Inputs" class="mode-inputs">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Target Position Size (%)</label>
                            <input type="number" id="targetPositionPct" class="form-control" step="0.1" min="0.1" placeholder="5">
                            <small class="text-muted">% of portfolio to allocate</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Stop Loss (%)</label>
                            <input type="number" id="stopLossPct" class="form-control" step="0.1" min="0.1" placeholder="2">
                            <small class="text-muted">% below entry price</small>
                        </div>
                    </div>
                </div>

                <!-- Mode 2 Inputs -->
                <div id="mode2Inputs" class="mode-inputs d-none">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Risk per Trade (%)</label>
                            <input type="number" id="riskPerTradePct" class="form-control" step="0.1" min="0.1" placeholder="1">
                            <small class="text-muted">% of portfolio you're willing to risk</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Stop Loss (%)</label>
                            <input type="number" id="stopLossPctMode2" class="form-control" step="0.1" min="0.1" placeholder="2">
                            <small class="text-muted">% below entry price</small>
                        </div>
                    </div>
                </div>

                <!-- Calculate Button -->
                <button id="calculateRiskBtn" class="btn btn-primary w-100 mb-3">
                    <i class="bi bi-calculator"></i> Calculate
                </button>

                <!-- Results -->
                <div id="riskResults" class="d-none">
                    <hr>
                    <h6 class="text-primary mb-3"><i class="bi bi-check-circle"></i> Results:</h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="result-item">
                                <small class="text-muted">Number of Shares</small>
                                <div class="h5 text-primary" id="resultShares">-</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="result-item">
                                <small class="text-muted">Position Value</small>
                                <div class="h5 text-primary" id="resultPositionValue">-</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="result-item">
                                <small class="text-muted">Position Size (%)</small>
                                <div class="h5 text-info" id="resultPositionPct">-</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="result-item">
                                <small class="text-muted">Stop Loss Price</small>
                                <div class="h5 text-warning" id="resultStopPrice">-</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="result-item">
                                <small class="text-muted">Risk Amount ($)</small>
                                <div class="h5 text-danger" id="resultRiskAmount">-</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="result-item">
                                <small class="text-muted">Risk as % of Equity</small>
                                <div class="h5 text-danger" id="resultRiskPct">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features Section -->
        <div class="row mt-5">
            <div class="col-md-4">
                <div class="card h-100 border-0">
                    <div class="card-body text-center">
                        <i class="bi bi-graph-up text-primary display-4 mb-3"></i>
                        <h5 class="card-title">Performance Metrics</h5>
                        <p class="card-text text-muted">Detailed analysis of your trading performance including win rates, profit/loss ratios, and more.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0">
                    <div class="card-body text-center">
                        <i class="bi bi-calendar3 text-primary display-4 mb-3"></i>
                        <h5 class="card-title">Time-Based Analysis</h5>
                        <p class="card-text text-muted">View your performance across different time periods: monthly, quarterly, and yearly.</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100 border-0">
                    <div class="card-body text-center">
                        <i class="bi bi-download text-primary display-4 mb-3"></i>
                        <h5 class="card-title">Export Options</h5>
                        <p class="card-text text-muted">Export your results to CSV, Excel, or generate comprehensive PDF reports.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- IBKR FlexQuery Setup Instructions -->
        <div class="card mt-5">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear me-2"></i>
                    How to Setup IBKR FlexQuery
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong>One-time setup required for automatic data fetching:</strong>
                </div>
                <ol class="mb-3">
                    <li class="mb-2">
                        <strong>Log into IBKR Account Management</strong>
                        <div class="text-muted small">Go to <code>Reports → Flex Queries</code></div>
                    </li>
                    <li class="mb-2">
                        <strong>Create Activity Flex Query</strong>
                        <div class="text-muted small">Include: Trades, Executions, and make sure to select all stock transactions</div>
                    </li>
                    <li class="mb-2">
                        <strong>Note the Query ID</strong>
                        <div class="text-muted small">Copy the generated Query ID for later use</div>
                    </li>
                    <li class="mb-2">
                        <strong>Enable FlexQuery Web Service</strong>
                        <div class="text-muted small">Go to <code>Reports → Settings → FlexQuery Web Service</code> and generate a token</div>
                    </li>
                </ol>
                <div class="alert alert-warning">
                    <small><i class="bi bi-shield-lock me-1"></i>Your credentials are only used for the current session and are never stored on our servers.</small>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card mt-5">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-question-circle me-2"></i>
                    How to Use
                </h5>
            </div>
            <div class="card-body">
                <ol class="mb-0">
                    <li class="mb-2">
                        <strong>Choose your data source:</strong>
                        Upload CSV files manually or fetch trades automatically from IBKR using FlexQuery API.
                    </li>
                    <li class="mb-2">
                        <strong>For CSV uploads:</strong>
                        Export your trades from IBKR and upload CSV files. Required columns: Symbol, TradeDate, Quantity, Price, Commission, Buy/Sell.
                    </li>
                    <li class="mb-2">
                        <strong>For IBKR API:</strong>
                        Setup FlexQuery (see instructions above), then enter your token and query ID to fetch trades automatically.
                    </li>
                    <li>
                        <strong>View results:</strong>
                        Once processed, you'll be redirected to a detailed results page with charts, tables, and export options.
                    </li>
                </ol>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Form elements
    const hybridForm = document.getElementById('hybridForm');
    const fileInput = document.getElementById('csvFile');
    const dropArea = document.getElementById('dropArea');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const alertArea = document.getElementById('alertArea');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const testConnectionBtn = document.getElementById('testConnectionBtn');
    const connectionStatus = document.getElementById('connectionStatus');

    // CSV Upload functionality (existing logic)
    if (dropArea && fileInput) {
        // Drag and drop functionality
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('border-primary');
        });

        dropArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropArea.classList.remove('border-primary');
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('border-primary');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        // Click to browse
        dropArea.addEventListener('click', () => {
            fileInput.click();
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                let invalidFiles = [];
                let largeFiles = [];

                files.forEach(file => {
                    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                        invalidFiles.push(file.name);
                    }
                    if (file.size > 10 * 1024 * 1024) { // 10MB
                        largeFiles.push(file.name);
                    }
                });

                if (invalidFiles.length > 0) {
                    showAlert(`Non-CSV files detected: ${invalidFiles.join(', ')}. Please select only CSV files.`, 'warning');
                    fileInput.value = '';
                    return;
                }

                if (largeFiles.length > 0) {
                    showAlert(`Files too large (>10MB): ${largeFiles.join(', ')}`, 'warning');
                    fileInput.value = '';
                    return;
                }

                const fileNames = files.map(f => f.name).join(', ');
                updateDropAreaText(`Selected ${files.length} file(s): ${fileNames}`);
            }
        });
    }

    // Hybrid form submission
    if (hybridForm) {
        hybridForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const files = fileInput.files;
            const token = document.getElementById('flexToken').value.trim();
            const queryId = document.getElementById('queryId').value.trim();
            const startYear = document.getElementById('startYear').value.trim();

            // Validation: At least one input method required
            const hasFiles = files && files.length > 0;
            const hasIBKRCredentials = token && queryId;

            if (!hasFiles && !hasIBKRCredentials) {
                showAlert('Please provide either CSV files or IBKR credentials (or both).', 'warning');
                return;
            }

            // Determine what we're processing
            let progressMessage = '';
            if (hasFiles && hasIBKRCredentials) {
                progressMessage = `Combining ${files.length} CSV file(s) with IBKR data...`;
            } else if (hasFiles) {
                progressMessage = `Processing ${files.length} CSV file(s)...`;
            } else {
                progressMessage = startYear ? `Fetching historical IBKR data (${startYear}-present)...` : 'Fetching IBKR data...';
            }

            showProgress(progressMessage);

            const formData = new FormData();
            
            // Add files if provided
            if (hasFiles) {
                for (let i = 0; i < files.length; i++) {
                    formData.append('files', files[i]);
                }
            }

            // Add IBKR credentials if provided
            if (hasIBKRCredentials) {
                formData.append('token', token);
                formData.append('query_id', queryId);
                if (startYear) {
                    formData.append('start_year', startYear);
                }
            }

            try {
                const response = await fetch('/api/hybrid-analyze', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showAlert(result.message, 'success');
                    setTimeout(() => {
                        window.location.href = `/results/${result.session_id}`;
                    }, 1500);
                } else {
                    showAlert(result.detail || 'Analysis failed', 'danger');
                    hideProgress();
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'danger');
                hideProgress();
            }
        });
    }

    // IBKR test connection
    if (testConnectionBtn) {
        testConnectionBtn.addEventListener('click', async () => {
            const token = document.getElementById('flexToken').value.trim();
            const queryId = document.getElementById('queryId').value.trim();

            if (!token || !queryId) {
                showAlert('Please enter both FlexQuery token and Query ID.', 'warning');
                return;
            }

            testConnectionBtn.disabled = true;
            connectionStatus.innerHTML = '<i class="spinner-border spinner-border-sm me-1"></i>Testing...';

            try {
                const response = await fetch('/api/test-ibkr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        token: token,
                        query_id: queryId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    connectionStatus.innerHTML = '<i class="bi bi-check-circle text-success me-1"></i>' + result.message;
                } else {
                    connectionStatus.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i>' + result.message;
                }
            } catch (error) {
                connectionStatus.innerHTML = '<i class="bi bi-x-circle text-danger me-1"></i>Connection test failed';
            } finally {
                testConnectionBtn.disabled = false;
            }
        });
    }


    // Utility functions
    function showProgress(message = 'Processing...') {
        progressContainer.classList.remove('d-none');
        if (analyzeBtn) analyzeBtn.disabled = true;
        progressBar.style.width = '100%';
        progressText.textContent = message;
    }

    function hideProgress() {
        progressContainer.classList.add('d-none');
        if (analyzeBtn) analyzeBtn.disabled = false;
        progressBar.style.width = '0%';
    }

    function showAlert(message, type) {
        alertArea.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }

    function updateDropAreaText(text) {
        if (dropArea) {
            dropArea.innerHTML = `
                <i class="bi bi-file-earmark-check display-4 mb-3 text-success"></i>
                <p class="mb-2">${text}</p>
                <p class="small text-muted">Click to select different files</p>
            `;
        }
    }

    // ==================== Risk Calculator Logic ====================

    const mode1Radio = document.getElementById('mode1');
    const mode2Radio = document.getElementById('mode2');
    const mode1Inputs = document.getElementById('mode1Inputs');
    const mode2Inputs = document.getElementById('mode2Inputs');
    const modeDescription = document.getElementById('modeDescription');

    if (mode1Radio && mode2Radio) {
        mode1Radio.addEventListener('change', () => {
            mode1Inputs.classList.remove('d-none');
            mode2Inputs.classList.add('d-none');
            document.getElementById('riskResults').classList.add('d-none');
            modeDescription.textContent = 'Enter target position size % and stop loss % to calculate shares and risk amount';
        });

        mode2Radio.addEventListener('change', () => {
            mode1Inputs.classList.add('d-none');
            mode2Inputs.classList.remove('d-none');
            document.getElementById('riskResults').classList.add('d-none');
            modeDescription.textContent = 'Enter risk per trade % and stop loss % to calculate optimal position size';
        });
    }

    const calculateRiskBtn = document.getElementById('calculateRiskBtn');
    if (calculateRiskBtn) {
        calculateRiskBtn.addEventListener('click', function() {
            const mode = document.querySelector('input[name="calcMode"]:checked').value;

            const symbol = document.getElementById('riskSymbol').value.trim();
            const entryPrice = parseFloat(document.getElementById('riskPrice').value);
            const portfolioSize = parseFloat(document.getElementById('riskPortfolio').value);

            if (!symbol) {
                alert('Please enter a symbol');
                return;
            }
            if (!entryPrice || entryPrice <= 0) {
                alert('Please enter a valid entry price');
                return;
            }
            if (!portfolioSize || portfolioSize <= 0) {
                alert('Please enter a valid portfolio size');
                return;
            }

            let results = {};

            if (mode === 'shares') {
                const targetPositionPct = parseFloat(document.getElementById('targetPositionPct').value);
                const stopLossPct = parseFloat(document.getElementById('stopLossPct').value);

                if (!targetPositionPct || targetPositionPct <= 0) {
                    alert('Please enter a valid target position size %');
                    return;
                }
                if (!stopLossPct || stopLossPct <= 0) {
                    alert('Please enter a valid stop loss %');
                    return;
                }

                results = calculateMode1(entryPrice, portfolioSize, targetPositionPct, stopLossPct);

            } else {
                const riskPerTradePct = parseFloat(document.getElementById('riskPerTradePct').value);
                const stopLossPct = parseFloat(document.getElementById('stopLossPctMode2').value);

                if (!riskPerTradePct || riskPerTradePct <= 0) {
                    alert('Please enter a valid risk per trade %');
                    return;
                }
                if (!stopLossPct || stopLossPct <= 0) {
                    alert('Please enter a valid stop loss %');
                    return;
                }

                results = calculateMode2(entryPrice, portfolioSize, riskPerTradePct, stopLossPct);
            }

            displayRiskResults(results);
        });
    }

    function calculateMode1(entryPrice, portfolioSize, targetPositionPct, stopLossPct) {
        const positionValue = (targetPositionPct / 100) * portfolioSize;
        const numShares = Math.floor(positionValue / entryPrice);
        const actualPositionValue = numShares * entryPrice;
        const actualPositionPct = (actualPositionValue / portfolioSize) * 100;
        const stopLossPrice = entryPrice * (1 - stopLossPct / 100);
        const riskPerShare = entryPrice - stopLossPrice;
        const riskAmount = numShares * riskPerShare;
        const riskPct = (riskAmount / portfolioSize) * 100;

        return {
            numShares,
            positionValue: actualPositionValue,
            positionPct: actualPositionPct,
            stopLossPrice,
            riskAmount,
            riskPct
        };
    }

    function calculateMode2(entryPrice, portfolioSize, riskPerTradePct, stopLossPct) {
        const desiredRiskAmount = (riskPerTradePct / 100) * portfolioSize;
        const stopLossPrice = entryPrice * (1 - stopLossPct / 100);
        const riskPerShare = entryPrice - stopLossPrice;
        const numShares = Math.floor(desiredRiskAmount / riskPerShare);
        const positionValue = numShares * entryPrice;
        const positionPct = (positionValue / portfolioSize) * 100;
        const actualRiskAmount = numShares * riskPerShare;
        const actualRiskPct = (actualRiskAmount / portfolioSize) * 100;

        return {
            numShares,
            positionValue,
            positionPct,
            stopLossPrice,
            riskAmount: actualRiskAmount,
            riskPct: actualRiskPct
        };
    }

    function displayRiskResults(results) {
        document.getElementById('resultShares').textContent = results.numShares.toLocaleString();
        document.getElementById('resultPositionValue').textContent = '$' + results.positionValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('resultPositionPct').textContent = results.positionPct.toFixed(2) + '%';
        document.getElementById('resultRiskAmount').textContent = '$' + results.riskAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        document.getElementById('resultRiskPct').textContent = results.riskPct.toFixed(2) + '%';
        document.getElementById('resultStopPrice').textContent = '$' + results.stopLossPrice.toFixed(2);
        document.getElementById('riskResults').classList.remove('d-none');
    }

    // ==================== End Risk Calculator Logic ====================
});
</script>
{% endblock %}